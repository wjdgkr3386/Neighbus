<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.neighbus.admin.AdminMapper">

    <!-- 전체 회원 목록 조회 -->
    <select id="selectAllUsers" resultType="map">
        SELECT
            u.id,
            u.name,
            u.username,
            u.email,
            u.phone,
            u.nickname,
            u.created_at,
            g.grade AS grade_name,
            u.grade AS grade_id,
            c.city AS city_name,
            p.province AS province_name
        FROM users u
        LEFT JOIN grades g ON u.grade = g.id
        LEFT JOIN cities c ON u.city = c.id
        LEFT JOIN provinces p ON c.province = p.id
        ORDER BY u.id ASC
    </select>

	<select id="selectAllUsersCount" resultType="int">
	
	</select>

    <!-- 회원 삭제 -->
    <delete id="deleteUser" parameterType="int">
        DELETE FROM users
        WHERE id = #{userId}
    </delete>

    <!-- 대시보드 통계 조회 -->
    <select id="selectDashboardStats" resultType="map">
        SELECT
            (SELECT COUNT(*) FROM users) AS totalUsers,
            (SELECT COUNT(*) FROM users WHERE DATE(created_at) = CURDATE()) AS todaySignups,
            (SELECT COUNT(*) FROM freeboards) + (SELECT COUNT(*) FROM galleries) AS totalPosts,
            (SELECT COUNT(*) FROM inquiries WHERE state = 1) AS pendingInquiries,
            (SELECT COUNT(*) FROM clubs) AS totalClubs,
            (SELECT COUNT(*) FROM recruitment) AS totalGatherings
    </select>

    <!-- 월별 가입자 수 조회 (최근 6개월) -->
    <select id="selectMonthlySignups" resultType="map">
        SELECT
            DATE_FORMAT(created_at, '%Y-%m') AS month,
            COUNT(*) AS count
        FROM users
        WHERE created_at >= DATE_SUB(NOW(), INTERVAL 6 MONTH)
        GROUP BY DATE_FORMAT(created_at, '%Y-%m')
        ORDER BY month ASC
    </select>

    <!-- 동아리별 회원 수 조회 (상위 5개) -->
    <select id="selectTopClubsByMembers" resultType="map">
        SELECT
            c.club_name AS clubName,
            COUNT(cm.user_id) AS memberCount
        FROM clubs c
        LEFT JOIN club_members cm ON c.id = cm.club_id
        GROUP BY c.id, c.club_name
        ORDER BY memberCount DESC
        LIMIT 5
    </select>

    <!-- 게시글 목록 조회 (댓글 수 포함) -->
    <select id="selectPostsWithCommentCount" resultType="map">
        SELECT
            f.id,
            f.title,
            f.content,
            f.writer,
            f.view_count AS viewCount,
            f.created_at AS createdAt,
            u.nickname AS writerNickname,
            u.username AS writerUsername,
            COUNT(c.id) AS commentCount
        FROM freeboards f
        LEFT JOIN users u ON f.writer = u.id
        LEFT JOIN freeboard_comments c ON f.id = c.freeboard
        GROUP BY f.id
        ORDER BY f.created_at DESC
        LIMIT 100
    </select>

    <!-- 동아리 목록 조회 (회원 수 포함) -->
    <select id="selectAllClubsWithMemberCount" resultType="map">
        SELECT
            c.id,
            c.club_name AS clubName,
            c.club_info AS clubInfo,
            c.created_at AS createdAt,
            ci.city AS cityName,
            p.province AS provinceName,
            COUNT(cm.user_id) AS memberCount
        FROM clubs c
        LEFT JOIN cities ci ON c.city = ci.id
        LEFT JOIN provinces p ON c.province_id = p.id
        LEFT JOIN club_members cm ON c.id = cm.club_id
        GROUP BY c.id
        ORDER BY c.created_at DESC
    </select>

    <!-- 동아리 삭제 -->
    <delete id="deleteClub" parameterType="int">
        DELETE FROM clubs
        WHERE id = #{clubId}
    </delete>

    <!-- 갤러리 목록 조회 -->
    <select id="selectAllGalleries" resultType="map">
        SELECT
            g.id AS galleryId,
            g.title,
            g.content,
            g.writer,
            g.club_id AS clubId,
            g.view_count AS viewCount,
            g.created_at AS createdAt,
            u.username AS writerUsername,
            u.nickname AS writerNickname,
            c.club_name AS clubName
        FROM galleries g
        LEFT JOIN users u ON g.writer = u.id
        LEFT JOIN clubs c ON g.club_id = c.id
        ORDER BY g.created_at DESC
        LIMIT 100
    </select>

    <!-- 갤러리 댓글 삭제 -->
    <delete id="deleteGalleryComments" parameterType="int">
        DELETE FROM gallery_comments
        WHERE gallery = #{galleryId}
    </delete>

    <!-- 갤러리 이미지 삭제 -->
    <delete id="deleteGalleryImages" parameterType="int">
        DELETE FROM gallery_images
        WHERE gallery = #{galleryId}
    </delete>

    <!-- 갤러리 삭제 -->
    <delete id="deleteGallery" parameterType="int">
        DELETE FROM galleries
        WHERE id = #{galleryId}
    </delete>

    <!-- 신고 접수 -->
    <insert id="insertReport" parameterType="com.neighbus.admin.ReportDTO">
        INSERT INTO reports (type, reporter_id, target_id, reason)
        VALUES (#{type}, #{reporterId}, #{targetId}, #{reason})
    </insert>

    <!-- 전체 신고 목록 조회 (상세보기 URL 포함) -->
    <select id="selectAllReports" resultType="com.neighbus.admin.ReportDTO">
        SELECT
            r.id,
            r.type,
            r.reporter_id AS reporterId,
            r.target_id AS targetId,
            r.reason,
            r.created_at AS createdAt,
            r.status,
            u.username AS reporterName,
            CASE
                WHEN r.type = 'POST' THEN CONCAT('/freeboard/', r.target_id)
                WHEN r.type = 'GALLERY' THEN CONCAT('/gallery/detail/', r.target_id)
                WHEN r.type = 'COMMENT' THEN
                    COALESCE(
                        (SELECT CONCAT('/freeboard/', fc.freeboard, '#comment-', r.target_id) FROM freeboard_comments fc WHERE fc.id = r.target_id),
                        (SELECT CONCAT('/gallery/detail/', gc.gallery, '#comment-', r.target_id) FROM gallery_comments gc WHERE gc.id = r.target_id)
                    )
            END AS targetUrl
        FROM
            reports r
        LEFT JOIN
            users u ON r.reporter_id = u.id
        ORDER BY
            r.created_at DESC
    </select>

    <!-- 신고 상태 변경 -->
    <update id="updateReportStatus">
        UPDATE reports
        SET status = #{status}
        WHERE id = #{id}
    </update>

    <!-- 신고 삭제 -->
    <delete id="deleteReport" parameterType="int">
        DELETE FROM reports
        WHERE id = #{id}
    </delete>

    <!-- 전체 신고 수 조회 -->
    <select id="countTotalReports" resultType="int">
        SELECT COUNT(*) FROM reports
    </select>

    <!-- 상태별 신고 수 조회 -->
    <select id="countReportsByStatus" resultType="int" parameterType="string">
        SELECT COUNT(*) FROM reports
        WHERE status = #{status}
    </select>

</mapper>
