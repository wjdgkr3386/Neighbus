<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="|${post.title} - ììœ ê²Œì‹œíŒ|">ê²Œì‹œê¸€ ìƒì„¸</title>
    <link href="/css/style.css" rel="stylesheet">
    <style>
        /* ëª©ë¡ í˜ì´ì§€ CSS ì¬ì‚¬ìš© ë° ìƒì„¸ í˜ì´ì§€ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 40px 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .post-container, .comment-section {
            background: #ffffff;
            border-radius: 24px;
            padding: 40px 50px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px; /* ì„¹ì…˜ ê°„ ê°„ê²© */
        }

        /* ----- ê²Œì‹œê¸€ í—¤ë” ìŠ¤íƒ€ì¼ ----- */
        .post-header {
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 25px;
            margin-bottom: 30px;
        }

        .post-title {
            font-size: 32px;
            font-weight: 800;
            color: #1f2937;
            margin-bottom: 15px;
            letter-spacing: -1px;
            line-height: 1.3;
        }

        .post-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
        }

        .post-meta-left {
            display: flex;
            gap: 20px;
        }
        
        .meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .meta-item .icon {
            width: 16px;
            height: 16px;
            color: #9ca3af;
        }

        /* ----- ê²Œì‹œê¸€ ë‚´ìš© ìŠ¤íƒ€ì¼ ----- */
        .post-content {
            min-height: 200px;
            color: #374151;
            font-size: 16px;
            line-height: 1.8;
            word-wrap: break-word;
        }
        
        .post-content p {
            margin-bottom: 15px;
        }

        /* ----- ë²„íŠ¼ ê·¸ë£¹ ìŠ¤íƒ€ì¼ (ê¸°ì¡´ ìœ ì§€) ----- */
        .button-group {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }

        .btn-list, .btn-action {
            padding: 12px 30px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-list {
            background: #f3f4f6;
            color: #6b7280;
        }
        
        .btn-edit {
            background: #667eea;
            color: white;
        }
        
        .btn-delete {
            background: #ef4444;
            color: white;
        }

        /* ----- ëŒ“ê¸€ ì„¹ì…˜ ìŠ¤íƒ€ì¼ ----- */
        .comment-section h3 {
            font-size: 20px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 25px;
        }
        
        .comment-form textarea {
            width: 100%;
            min-height: 80px;
            padding: 15px;
            border: 1px solid #d1d5db;
            border-radius: 10px;
            resize: vertical;
            font-family: inherit;
            font-size: 15px;
            margin-bottom: 10px;
        }

        .comment-form button {
            float: right;
            padding: 10px 20px;
            background: #764ba2;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .comment-form button:hover {
            background: #667eea;
        }

        .comment-list {
            list-style: none;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
            margin-top: 20px;
        }

        .comment-item {
            padding: 15px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .comment-writer {
            font-weight: 700;
            color: #1f2937;
            font-size: 14px;
        }

        .comment-meta-actions {
            display: flex;
            gap: 10px;
            color: #9ca3af;
            font-size: 12px;
        }
        
        .comment-date {
            margin-right: 10px;
        }

        .comment-delete-btn {
            color: #ef4444;
            cursor: pointer;
            text-decoration: none;
        }
        
        .comment-content-text {
            color: #374151;
            font-size: 15px;
            line-height: 1.5;
            white-space: pre-wrap; /* ì¤„ë°”ê¿ˆ ìœ ì§€ */
        }
    </style>
</head>

<body>
	<div class="container">
		<div class="post-container">
            <!-- -------------------------------------------------- -->
            <!-- ê²Œì‹œê¸€ ìƒì„¸ ë‚´ìš© ì˜ì—­ -->
            <!-- -------------------------------------------------- -->
            <div class="post-header">
                <div class="post-title" th:text="${post.title}">ê²Œì‹œê¸€ ì œëª©</div>
                
                <div class="post-meta">
					<div class="post-meta-left">
                        <span class="meta-item">
							<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
									d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z">
								</path>
							</svg>
							<!-- ğŸš¨ ìˆ˜ì •: post.writerUsername ëŒ€ì‹  post.writerNickname ì‚¬ìš© -->
							<span th:text="${post.writerNickname}">ì‘ì„±ì</span> 
						</span>
                        
                        <span class="meta-item">
							<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
									d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
								</path>
							</svg>
							<span th:text="${#temporals.format(post.createdAt, 'yyyy.MM.dd HH:mm')}">2025.11.04 10:00</span>
						</span>

                        <span class="meta-item">
							<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
									d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
									d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z">
								</path>
							</svg>
							<span th:text="${post.viewCount}">1,234</span>
						</span>
					</div>
                    
                    <div class="post-meta-right"></div>
				</div>
			</div>

            <div class="post-content">
                <p th:text="${post.content}">ì—¬ê¸°ì— ê²Œì‹œê¸€ ë‚´ìš©ì´ í‘œì‹œë©ë‹ˆë‹¤. ì¤„ë°”ê¿ˆì´ í•„ìš”í•œ ê²½ìš°, í…ìŠ¤íŠ¸ë¥¼ ì²˜ë¦¬í•´ì•¼ í•©ë‹ˆë‹¤.</p>
            </div>
            
            <div class="button-group">
                <a th:href="@{/freeboard}" class="btn-list">ëª©ë¡ìœ¼ë¡œ</a>
                
                <div class="post-actions">
                    <!-- ğŸš¨ ê¶Œí•œ ì²´í¬ë¥¼ ìœ„í•œ Thymeleaf ì¡°ê±´ ì¶”ê°€ í•„ìš” (ì˜ˆ: th:if="${post.writer == #authentication.principal.id}") -->
                    <a th:href="@{|/freeboard/edit/${post.id}|}" class="btn-action btn-edit">ìˆ˜ì •</a>
                    <a th:href="@{|/freeboard/delete/${post.id}|}" class="btn-action btn-delete">ì‚­ì œ</a>
                </div>
            </div>

		</div>
        
        <!-- -------------------------------------------------- -->
        <!-- ëŒ“ê¸€ ì„¹ì…˜ -->
        <!-- -------------------------------------------------- -->
        <div class="comment-section">
            <h3>ëŒ“ê¸€ (<span th:text="${#lists.size(comments)}">0</span>)</h3>
            
            <!-- ëŒ“ê¸€ ë“±ë¡ í¼ -->
            <form id="commentForm" class="comment-form">
                <!-- freeboardIdë¥¼ ìˆ¨ê²¨ì§„ í•„ë“œë¡œ ì „ë‹¬ -->
                <input type="hidden" id="freeboardId" name="freeboard" th:value="${post.id}">
                <!-- parentIdëŠ” ëŒ€ëŒ“ê¸€ ê¸°ëŠ¥ ì‹œ ì‚¬ìš© (í˜„ì¬ëŠ” ì£¼ì„ ì²˜ë¦¬) -->
                <!-- <input type="hidden" id="parentId" name="parent" value=""> -->
                
                <textarea id="commentContent" name="content" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." required></textarea>
                <button type="submit" id="submitCommentBtn">ë“±ë¡</button>
                <div style="clear: both;"></div>
            </form>

            <!-- ëŒ“ê¸€ ëª©ë¡ -->
            <ul class="comment-list" id="commentList">
                <li class="comment-item" th:each="comment : ${comments}" th:id="|comment-${comment.id}|">
                    <div class="comment-header"> 
						ì‘ì„±ì:<span class="comment-writer" th:text="${comment.writerNickname}">ìµëª…</span>
                        <div class="comment-meta-actions">
                            <span class="comment-date" th:text="${#temporals.format(comment.createdAt, 'yyyy.MM.dd HH:mm')}">2025.11.04 10:00</span>
                            <!-- ğŸš¨ ê¶Œí•œì´ ìˆëŠ” ê²½ìš°ì—ë§Œ ì‚­ì œ ë²„íŠ¼ í‘œì‹œ -->
                            <!-- í˜„ì¬ ë¡œê·¸ì¸í•œ ìœ ì € IDë¥¼ Spring Securityì—ì„œ ê°€ì ¸ì™€ì•¼ í•¨ (#authentication.principal.id) -->
                            <a href="#" class="comment-delete-btn" 
                               th:attr="data-comment-id=${comment.id}"
                               onclick="deleteComment(this.getAttribute('data-comment-id')); return false;">ì‚­ì œ</a>
                        </div>
                    </div>
                    <div class="comment-content-text" th:text="${comment.content}">ëŒ“ê¸€ ë‚´ìš©ì…ë‹ˆë‹¤.</div>
                </li>
            </ul>
        </div>
	</div>

<script th:inline="javascript">
/*<![CDATA[*/
    
    // í˜„ì¬ ê²Œì‹œê¸€ ID
    const postId = /*[[${post.id}]]*/ 0;
    // Spring Securityì—ì„œ í˜„ì¬ ìœ ì € IDë¥¼ ê°€ì ¸ì™€ì•¼ í•©ë‹ˆë‹¤. (ì´ ë¶€ë¶„ì€ í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì§ì ‘ ì ‘ê·¼ ë¶ˆê°€)
    // Controllerì—ì„œ model.addAttribute("currentUserId", accountDTO.getId())ë¥¼ ì¶”ê°€í•˜ëŠ” ê²ƒì´ ì•ˆì „í•©ë‹ˆë‹¤.
    const currentUserId = /*[[${#authentication != null ? #authentication.principal.id : null}]]*/ null; 

    // --------------------------------------------------
    // 1. ëŒ“ê¸€ ë“±ë¡ (AJAX POST)
    // --------------------------------------------------

    document.getElementById('commentForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const content = document.getElementById('commentContent').value.trim();
        const freeboardId = document.getElementById('freeboardId').value;
        
        if (!content) {
            alert('ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        const commentData = {
            freeboard: freeboardId,
            content: content
            // parent: parentId (ëŒ€ëŒ“ê¸€ ì‹œ ì‚¬ìš©)
        };

        try {
            const response = await fetch('/freeboard/comment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(commentData)
            });

            const result = await response.text();

            if (response.ok) {
                alert(result);
                document.getElementById('commentContent').value = ''; // í¼ ì´ˆê¸°í™”
                location.reload(); // ì„±ê³µ ì‹œ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ (ê°„ë‹¨í•œ ë°©ë²•)
            } else {
                alert('ë“±ë¡ ì‹¤íŒ¨: ' + result);
            }
        } catch (error) {
            console.error('Error submitting comment:', error);
            alert('ëŒ“ê¸€ ë“±ë¡ ì¤‘ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    });

    // --------------------------------------------------
    // 2. ëŒ“ê¸€ ì‚­ì œ (AJAX DELETE)
    // --------------------------------------------------
    
    window.deleteComment = async function(commentId) {
        if (!confirm('ì •ë§ë¡œ ì´ ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            return;
        }

        try {
            const response = await fetch(`/freeboard/comment/${commentId}`, {
                method: 'DELETE'
            });

            const result = await response.text();

            if (response.ok) {
                alert(result);
                // ì‚­ì œ ì„±ê³µ ì‹œ DOMì—ì„œ ëŒ“ê¸€ ì œê±°
                const commentElement = document.getElementById(`comment-${commentId}`);
                if (commentElement) {
                    commentElement.remove();
                }
                // ëŒ“ê¸€ ìˆ˜ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´ ìƒˆë¡œê³ ì¹¨ì„ ì‚¬ìš©í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
                // location.reload(); 
            } else {
                alert('ì‚­ì œ ì‹¤íŒ¨: ' + result);
            }
        } catch (error) {
            console.error('Error deleting comment:', error);
            alert('ëŒ“ê¸€ ì‚­ì œ ì¤‘ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }
    
    // --------------------------------------------------
    // 3. ê¶Œí•œì— ë”°ë¥¸ ë²„íŠ¼ í‘œì‹œ (í”„ë¡ íŠ¸ì—”ë“œ ì„ì‹œ ë¡œì§)
    // --------------------------------------------------
    // ë°±ì—”ë“œì—ì„œ writerì™€ currentUserIdë¥¼ ë¹„êµí•˜ì—¬ ê¶Œí•œì„ ë„˜ê²¨ì£¼ëŠ” ê²ƒì´ ë” ì•ˆì „í•©ë‹ˆë‹¤.
    // í˜„ì¬ëŠ” ëª¨ë“  ëŒ“ê¸€ì— ì‚­ì œ ë²„íŠ¼ì´ í‘œì‹œë˜ë¯€ë¡œ, ì‹¤ì œ ì„œë²„ ë¡œì§ì´ ì‘ë™í•´ì•¼ ê¶Œí•œì´ ì²´í¬ë©ë‹ˆë‹¤.

/*]]>*/
</script>
</body>
</html>