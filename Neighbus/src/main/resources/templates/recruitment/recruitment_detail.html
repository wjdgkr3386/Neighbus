<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title th:text="${recruitment.title}">모임 상세</title>
	<link href="https://cdn.jsdelivr.net/gh/sunn-us/SUIT/fonts/static/woff2/SUIT.css" rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<link rel="stylesheet" href="/css/navibar.css">
	<script type="text/javascript" th:src="|//dapi.kakao.com/v2/maps/sdk.js?appkey=${kakaoApiKey}|"></script>
	<style>
		:root {
			--primary: #A67C52;
			--primary-dark: #8D6E63;
			--primary-light: #C9A88A;
			--accent-gold: #D4AF87;
			--secondary: #F5DEB3;
			--secondary-light: #F5E6D3;
			--secondary-lighter: #FAF0E6;
			--bg-ivory: #FFF8F0;
			--bg-warm: #FFF5EB;
			--bg-cream: #FAF0E6;
			--card-bg: #FFFBF7;
			--text-primary: #5D4037;
			--text-secondary: #8D6E63;
			--text-light: #A1887F;
			--border-color: #E8D7C3;
			--shadow-color: rgba(166, 124, 82, 0.15);
			--shadow-hover: rgba(166, 124, 82, 0.25);
			--white: #FFFFFF;
		}

		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: 'SUIT', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
			background: linear-gradient(165deg, var(--bg-ivory) 0%, var(--bg-warm) 50%, var(--bg-cream) 100%);
			color: var(--text-primary);
			line-height: 1.6;
			min-height: 100vh;
			padding-top: 100px;
			padding-bottom: 60px;
		}

		.container {
			max-width: 900px;
		}

		/* 헤더 영역 */
		.detail-header {
			background: var(--card-bg);
			border: none;
			border-radius: 24px;
			padding: 2.5rem;
			margin-bottom: 1.5rem;
			box-shadow:
				0 2px 8px rgba(166, 124, 82, 0.08),
				0 4px 16px rgba(166, 124, 82, 0.06),
				0 0 0 1px rgba(166, 124, 82, 0.04);
			transition: all 0.3s ease;
		}

		.detail-header:hover {
			box-shadow:
				0 4px 12px rgba(166, 124, 82, 0.12),
				0 8px 24px rgba(166, 124, 82, 0.08),
				0 0 0 1px rgba(166, 124, 82, 0.06);
			transform: translateY(-2px);
		}

		.detail-title {
			font-size: 2rem;
			font-weight: 800;
			color: var(--text-primary);
			margin-bottom: 1.25rem;
			line-height: 1.4;
		}

		.detail-meta {
			display: flex;
			flex-wrap: wrap;
			gap: 1rem;
			color: var(--text-secondary);
			font-size: 0.9rem;
			align-items: center;
		}

		.meta-item {
			display: flex;
			align-items: center;
			gap: 0.5rem;
		}

		.meta-item i {
			color: var(--primary);
			font-size: 1rem;
		}

		.meta-item strong {
			color: var(--text-primary);
			font-weight: 600;
		}

		.meta-divider {
			color: var(--border-color);
			font-size: 0.75rem;
		}

		/* 콘텐츠 카드 */
		.content-card {
			background: var(--card-bg);
			border: none;
			border-radius: 24px;
			padding: 2rem 2.5rem;
			margin-bottom: 1.5rem;
			box-shadow:
				0 2px 8px rgba(166, 124, 82, 0.08),
				0 4px 16px rgba(166, 124, 82, 0.06),
				0 0 0 1px rgba(166, 124, 82, 0.04);
			transition: all 0.3s ease;
		}

		.content-card:hover {
			box-shadow:
				0 4px 12px rgba(166, 124, 82, 0.12),
				0 8px 24px rgba(166, 124, 82, 0.08),
				0 0 0 1px rgba(166, 124, 82, 0.06);
			transform: translateY(-2px);
		}

		.content-card h2 {
			font-size: 1.25rem;
			font-weight: 700;
			color: var(--text-primary);
			margin-bottom: 1.25rem;
			padding-bottom: 0.75rem;
			border-bottom: 2px solid var(--secondary-lighter);
			display: flex;
			align-items: center;
			gap: 0.5rem;
		}

		.content-card h2 i {
			color: var(--primary);
			font-size: 1.1rem;
		}

		.content-card p {
			color: var(--text-primary);
			line-height: 1.8;
			white-space: pre-wrap;
			font-size: 1rem;
		}

		#map {
			width: 100%;
			height: 350px;
			border-radius: 16px;
			margin-top: 1rem;
			background-color: var(--secondary-lighter);
			display: flex;
			align-items: center;
			justify-content: center;
			color: var(--text-secondary);
			font-weight: 500;
			box-shadow: inset 0 2px 4px rgba(166, 124, 82, 0.06);
		}

		/* 버튼 그룹 */
		.button-group {
			display: flex;
			gap: 0.75rem;
			margin-top: 1.5rem;
			padding-top: 1.5rem;
			border-top: 1px solid var(--border-color);
		}

		.button-left {
			display: flex;
			gap: 0.75rem;
			flex: 1;
		}

		.button-right {
			display: flex;
			gap: 0.75rem;
			margin-left: auto;
		}

		/* 부트스트랩 버튼 커스터마이징 */
		.btn {
			border-radius: 12px;
			font-weight: 600;
			padding: 0.6rem 1.25rem;
			transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
			box-shadow: 0 2px 8px rgba(166, 124, 82, 0.1);
			font-size: 0.9rem;
		}

		.btn:hover {
			transform: translateY(-3px);
			box-shadow: 0 4px 12px rgba(166, 124, 82, 0.2);
		}

		.btn-primary {
			background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
			border: none;
			color: white;
		}

		.btn-primary:hover {
			background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
			color: white;
		}

		.btn-success {
			background: linear-gradient(135deg, #5A8B73 0%, #4A7A63 100%);
			border: none;
		}

		.btn-success:hover {
			background: linear-gradient(135deg, #4A7A63 0%, #5A8B73 100%);
		}

		.btn-warning {
			background: linear-gradient(135deg, #D4AF87 0%, #C9A88A 100%);
			border: none;
			color: var(--text-primary);
		}

		.btn-warning:hover {
			background: linear-gradient(135deg, #C9A88A 0%, #D4AF87 100%);
			color: var(--text-primary);
		}

		.btn-danger {
			background: linear-gradient(135deg, #C87E7E 0%, #B36A6A 100%);
			border: none;
		}

		.btn-danger:hover {
			background: linear-gradient(135deg, #B36A6A 0%, #C87E7E 100%);
		}

		.btn-secondary,
		.btn-outline-secondary {
			background: var(--white);
			color: var(--text-primary);
			border: 2px solid var(--border-color);
		}

		.btn-secondary:hover,
		.btn-outline-secondary:hover {
			background: var(--secondary-lighter);
			border-color: var(--primary);
			color: var(--primary);
		}

		.btn-chat {
			background: linear-gradient(135deg, var(--accent-gold) 0%, var(--primary-light) 100%);
			color: white;
			border: none;
		}

		.btn-chat:hover {
			background: linear-gradient(135deg, var(--primary-light) 0%, var(--accent-gold) 100%);
			color: white;
		}

		/* 인원 정보 강조 */
		.user-count {
			display: inline-block;
			background: linear-gradient(135deg, var(--secondary-light) 0%, var(--secondary-lighter) 100%);
			color: var(--primary);
			padding: 0.3rem 0.75rem;
			border-radius: 12px;
			font-weight: 700;
			font-size: 0.9rem;
			box-shadow: 0 2px 6px rgba(166, 124, 82, 0.12);
		}

		/* 반응형 디자인 */
		@media (max-width: 768px) {
			body {
				padding-top: 80px;
			}

			.detail-header {
				padding: 1.5rem;
			}

			.detail-title {
				font-size: 1.5rem;
			}

			.detail-meta {
				flex-direction: column;
				gap: 0.5rem;
				align-items: flex-start;
			}

			.meta-divider {
				display: none;
			}

			.content-card {
				padding: 1.5rem;
			}

			.button-group {
				flex-direction: column;
			}

			.button-left,
			.button-right {
				flex-direction: column;
				width: 100%;
			}

			.btn {
				width: 100%;
				justify-content: center;
			}
		}
	</style>
</head>

<body>
	<!-- 네비바 -->
	<div th:replace="include/navibar :: header-nav"></div>

	<!--
      컨트롤러에서 model.addAttribute("recruitment", recruitmentDTO)로
      전달된 DTO 객체를 바인딩합니다.
    -->
	<div class="container my-4" th:object="${recruitment}">

		<!-- 모임 ID를 스크립트에서 사용하기 위해 data 속성에 저장 -->
		<div id="recruitment-container" th:data-recruitment-id="*{id}">

			<!-- 헤더 영역 -->
			<div class="detail-header">
				<h1 class="detail-title" th:text="*{title}">모임 제목이 여기에 표시됩니다</h1>

				<!-- 메타 정보 (작성자, 날짜, 인원) -->
				<div class="detail-meta">
					<div class="meta-item">
						<i class="fa-solid fa-user"></i>
						<span>작성자 ID: <strong th:text="*{writer}"></strong></span>
					</div>
					<span class="meta-divider">|</span>
					<div class="meta-item">
						<i class="fa-solid fa-calendar-days"></i>
						<span>모임 날짜: <strong th:text="*{meetingDate}"></strong></span>
					</div>
					<span class="meta-divider">|</span>
					<div class="meta-item">
						<i class="fa-solid fa-users"></i>
						<span>인원:
							<span class="user-count">
								<span th:text="${currentUserCount}">0</span> / <span th:text="*{maxUser}"></span>
							</span>
						</span>
					</div>
				</div>
			</div>

			<!-- 모임 내용 -->
			<div class="content-card">
				<h2><i class="fa-solid fa-align-left"></i>모임 내용</h2>
				<!-- th:utext를 사용하면 HTML 렌더링이 가능 (XSS 주의), th:text는 순수 텍스트 -->
				<p th:text="*{content}">모임 상세 내용이 여기에 표시됩니다.</p>
			</div>

			<!-- 장소 -->
			<div class="content-card">
				<h2><i class="fa-solid fa-location-dot"></i>만날 장소</h2>
				<p th:text="*{address}">만날 장소 주소가 여기에 표시됩니다.</p>
				<div id="map"></div>
			</div>
		</div>

		<!-- 버튼 그룹 -->
		<div class="button-group">
			<!-- 왼쪽: 목록 버튼 -->
			<div class="button-left">
				<a href="/club/myClubPage" class="btn btn-secondary">
					<i class="fa-solid fa-list"></i>
					내가 가입한 동아리
				</a>
				
			</div>

			<!-- 오른쪽: 기능 버튼들 -->
			<div class="button-right">
				<!--
                  가입/탈퇴/삭제는 API 컨트롤러(/api/recruitment/...)를 호출해야 하므로
                  JavaScript(fetch)를 사용합니다.
                -->
				<button onclick="joinRecruitment()" class="btn btn-success">
					<i class="fa-solid fa-user-plus"></i>
					가입하기
				</button>
				<button th:onclick="|openChat('${id}')|" class="btn btn-chat">
					<i class="fa-solid fa-comments"></i> 채팅하기
				</button>
				<a th:unless="${chatRoomExists}" 
				       href="javascript:void(0);" 
				       class="btn btn-chat"
				       th:data-id="${recruitment.id}"
				       th:data-title="${recruitment.title}"
				       onclick="createAndEnterChat(this.getAttribute('data-id'), this.getAttribute('data-title'))">
				        <i class="fa-solid fa-plus"></i> 채팅방 생성
				    </a>
				<button onclick="withdrawalRecruitment()" class="btn btn-warning">
					<i class="fa-solid fa-user-minus"></i>
					탈퇴하기
				</button>
				<button onclick="deleteRecruitment()" class="btn btn-danger">
					<i class="fa-solid fa-trash"></i>
					삭제
				</button>
			</div>
		</div>
	</div>
	<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
	<script th:inline="javascript">

		// (간소화) CSRF가 비활성화된 경우의 헤더
		const headers = {'Content-Type': 'application/json'};

		// data 속성에서 모임 ID 가져오기
		const recruitmentId = document.getElementById('recruitment-container').dataset.recruitmentId;

		// 1. 모임 가입
		async function joinRecruitment() {
			if (!confirm('모임에 가입하시겠습니까?')) return;

			try {
				const response = await fetch('/api/recruitment/join', {
					method: 'POST',
					headers: headers,
					body: JSON.stringify({recruitmentId: recruitmentId})
				});

				const message = await response.text();
				alert(message);

				if (response.ok) {
					location.reload(); // 페이지 새로고침
				}
			} catch (error) {
				console.error('Error joining:', error);
				alert('요청 중 오류가 발생했습니다.');
			}
		}

		// 2. 모임 탈퇴
		async function withdrawalRecruitment() {
			if (!confirm('모임에서 탈퇴하시겠습니까?')) return;

			try {
				const response = await fetch('/api/recruitment/withdrawal', {
					method: 'DELETE',
					headers: headers,
					body: JSON.stringify({recruitmentId: recruitmentId})
				});

				const message = await response.text();
				alert(message);

				if (response.ok) {
					location.reload();
				}
			} catch (error) {
				console.error('Error withdrawing:', error);
				alert('요청 중 오류가 발생했습니다.');
			}
		}

		// 3. 모임 삭제
		async function deleteRecruitment() {
			if (!confirm('정말로 이 모임을 삭제하시겠습니까? (작성자만 가능)')) return;

			try {
				// ID를 URL 경로에 포함
				const response = await fetch(`/api/recruitment/${recruitmentId}`, {
					method: 'DELETE',
					headers: headers
				});

				const message = await response.text();
				alert(message);

				if (response.ok) {
					window.location.href = '/recruitment'; // 목록 페이지로 이동
				}
			} catch (error) {
				console.error('Error deleting:', error);
				alert('요청 중 오류가 발생했습니다.');
			}
		}

		// 4. 채팅 열기
		function openChat(id) {
			// 1. 새 창(팝업)으로 열기
			window.open('/chat/room/enter/' + id, '_blank', 'width=850,height=750,resizable=yes');

			// OR

			// 2. 현재 창에서 이동하기
			// location.href = '/chat/room/enter/' + id;
		}
		// 채팅 입장
		function createChatRoom(recruitId, recruitTitle) {
			// 콘솔로 데이터가 잘 넘어왔는지 확인
			console.log("ID:", recruitId, "Title:", recruitTitle);

			var params = new URLSearchParams();
			params.append("roomId", recruitId);
			params.append("name", recruitTitle);

			axios.post('/chat/room', params)
				.then(response => {
					// 성공 시 새 창으로 채팅방 열기
					window.open("/chat/room/enter/" + recruitId, "_blank", "width=500,height=700");
				})
				.catch(error => {
					console.error(error);
					alert("채팅방 입장 실패!");
				});
		}
		// 채팅방 생성
		function createAndEnterChat(recruitId, recruitTitle) {

			console.log("채팅방 생성 시도: ", recruitId, recruitTitle);

			var params = new URLSearchParams();
			params.append("roomId", recruitId);   // 게시글 ID
			params.append("name", recruitTitle);  // 게시글 제목

			axios.post('/chat/room', params)
				.then(function (response) {
					// 성공 시 채팅방 팝업 열기
					var url = "/chat/room/enter/" + recruitId;
					var name = "ChatRoom_" + recruitId;
					var specs = "width=500,height=700,scrollbars=yes,resizable=yes";

					window.open(url, name, specs);
				})
				.catch(function (error) {
					console.error("채팅방 생성 실패:", error);
					alert("채팅방 입장에 실패했습니다. (로그인을 확인해주세요)");
				});
		}

		// 카카오맵 초기화
		document.addEventListener('DOMContentLoaded', function() {
			const lat = /*[[${recruitment.latitude}]]*/ null;
			const lng = /*[[${recruitment.longitude}]]*/ null;
			const placeName = /*[[${recruitment.address}]]*/ '만남의 장소';
			const mapContainer = document.getElementById('map');

			if (lat && lng) {
				const mapOption = {
					center: new kakao.maps.LatLng(lat, lng),
					level: 3
				};

				const map = new kakao.maps.Map(mapContainer, mapOption);

				const marker = new kakao.maps.Marker({
					position: new kakao.maps.LatLng(lat, lng)
				});
				marker.setMap(map);

				const infowindow = new kakao.maps.InfoWindow({
					content: `<div style="padding:5px;font-size:12px;text-align:center;">${placeName}</div>`
				});
				infowindow.open(map, marker);
			} else {
				mapContainer.innerHTML = '위치 정보가 등록되지 않은 모임입니다.';
			}
		});
	</script>

	<!-- Bootstrap JS -->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>