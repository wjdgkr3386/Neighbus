<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta name="_csrf" th:content="${_csrf.token}" />
	<meta name="_csrf_header" th:content="${_csrf.headerName}" />
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>NEIGHBUS - 친구 목록</title>

	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
	<link href="https://cdn.jsdelivr.net/gh/sunn-us/SUIT/fonts/static/woff2/SUIT.css" rel="stylesheet">
	<link rel="stylesheet" href="/css/navibar.css">

	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		:root {
			--primary: #A67C52;
			--primary-dark: #8D6E63;
			--primary-light: #C9A88A;
			--accent-red: #C87E7E;
			--bg-ivory: #FFF8F0;
			--bg-warm: #FFF5EB;
			--card-bg: #FFFBF7;
			--text-primary: #5D4037;
			--text-secondary: #8D6E63;
			--border-color: #E8D7C3;
			--shadow-color: rgba(166, 124, 82, 0.1);
			--white: #FFFFFF;
		}

		body {
			font-family: 'SUIT', sans-serif;
			color: var(--text-primary);
			background: linear-gradient(165deg, var(--bg-ivory) 0%, var(--bg-warm) 50%, #FAF0E6 100%);
			overflow-x: hidden;
			min-height: 100vh;
			padding-top: 100px;
			/* 네비바 높이만큼 패딩 추가 */
		}

		/* --- 친구 목록 & 채팅 페이지 전용 스타일 --- */

		.main-container {
			max-width: 1200px;
			margin: 0 auto;
			padding: 2rem;
			height: calc(100vh - 120px);
			/* 네비게이션 높이 + padding 제외 */
			display: flex;
			gap: 1.5rem;
			position: relative;
			overflow: hidden;
		}

		/* 1. 친구 목록 영역 */
		.friend-section {
			flex: 1;
			/* 기본적으로 꽉 채움 */
			background: var(--white);
			border-radius: 20px;
			box-shadow: 0 10px 30px var(--shadow-color);
			border: 1px solid var(--border-color);
			display: flex;
			flex-direction: column;
			transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
			height: 100%;
			z-index: 10;
		}

		/* 채팅방이 열렸을 때 친구 목록 스타일 (폭이 줄어듦) */
		.friend-section.shrink {
			flex: 0 0 400px;
			/* 고정 너비 혹은 %로 설정 가능 */
		}

		.section-header {
			padding: 1.5rem 2rem;
			border-bottom: 1px solid var(--border-color);
			background: var(--bg-warm);
			border-radius: 20px 20px 0 0;
		}

		.section-title-text {
			font-size: 1.2rem;
			font-weight: 800;
			color: var(--text-primary);
		}

		.friend-list-wrapper {
			flex: 1;
			overflow-y: auto;
			padding: 1rem;
		}

		/* 스크롤바 커스텀 */
		.friend-list-wrapper::-webkit-scrollbar {
			width: 6px;
		}

		.friend-list-wrapper::-webkit-scrollbar-thumb {
			background: var(--primary-light);
			border-radius: 10px;
		}

		.friend-card {
			display: flex;
			align-items: center;
			background: var(--card-bg);
			padding: 1rem;
			border-radius: 12px;
			margin-bottom: 1rem;
			border: 1px solid transparent;
			transition: all 0.3s ease;
		}

		.friend-card:hover {
			border-color: var(--primary-light);
			box-shadow: 0 4px 12px var(--shadow-color);
			transform: translateY(-2px);
		}

		.friend-avatar {
			width: 50px;
			height: 50px;
			border-radius: 50%;
			object-fit: cover;
			border: 2px solid var(--bg-ivory);
			box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
		}

		.friend-info {
			flex: 1;
			margin-left: 1rem;
		}

		.friend-name {
			font-weight: 700;
			font-size: 1rem;
			color: var(--text-primary);
		}

		.friend-status {
			font-size: 0.85rem;
			color: var(--text-secondary);
			margin-top: 2px;
		}

		.friend-actions {
			display: flex;
			gap: 0.5rem;
		}

		.btn-action {
			padding: 0.4rem 0.8rem;
			border-radius: 8px;
			font-size: 0.85rem;
			font-weight: 600;
			cursor: pointer;
			transition: all 0.2s;
			border: 1px solid transparent;
		}

		.btn-chat {
			background-color: var(--bg-ivory);
			color: var(--primary);
			border-color: var(--primary);
		}

		.btn-chat:hover {
			background-color: var(--primary);
			color: var(--white);
		}

		.btn-delete {
			background-color: transparent;
			color: var(--accent-red);
		}

		.btn-delete:hover {
			background-color: #FFF0F0;
		}

		/* 2. 채팅창 영역 */
		.chat-section {
			position: absolute;
			/* 슬라이딩 효과를 위해 absolute 혹은 flex로 제어 */
			right: 2rem;
			/* main-container padding 고려 */
			top: 2rem;
			bottom: 2rem;
			width: calc(100% - 400px - 3.5rem);
			/* 전체 - 친구목록너비 - 간격 */
			background: var(--white);
			border-radius: 20px;
			box-shadow: 0 10px 30px var(--shadow-color);
			border: 1px solid var(--border-color);
			display: flex;
			flex-direction: column;

			/* 애니메이션 초기 상태: 숨김 */
			transform: translateX(110%);
			opacity: 0;
			transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
			z-index: 5;
		}

		/* 채팅방 열림 상태 */
		.chat-section.active {
			transform: translateX(0);
			opacity: 1;
		}

		.chat-header {
			padding: 1rem 1.5rem;
			border-bottom: 1px solid var(--border-color);
			display: flex;
			justify-content: space-between;
			align-items: center;
			background: var(--bg-warm);
			border-radius: 20px 20px 0 0;
		}

		.chat-user-info {
			display: flex;
			align-items: center;
			gap: 10px;
			font-weight: 700;
		}

		.btn-close-chat {
			background: none;
			border: none;
			font-size: 1.2rem;
			color: var(--text-secondary);
			cursor: pointer;
		}

		.chat-body {
			flex: 1;
			padding: 1.5rem;
			overflow-y: auto;
			background-color: var(--bg-ivory);
			display: flex;
			flex-direction: column;
			gap: 1rem;
		}

		.chat-bubble {
			max-width: 70%;
			padding: 0.8rem 1.2rem;
			border-radius: 15px;
			font-size: 0.95rem;
			line-height: 1.5;
			position: relative;
		}

		.chat-bubble.receive {
			background: var(--white);
			color: var(--text-primary);
			align-self: flex-start;
			border-bottom-left-radius: 2px;
			border: 1px solid var(--border-color);
		}

		.chat-bubble.sent {
			background: var(--primary);
			color: var(--white);
			align-self: flex-end;
			border-bottom-right-radius: 2px;
		}

		.chat-footer {
			padding: 1rem;
			background: var(--white);
			border-top: 1px solid var(--border-color);
			border-radius: 0 0 20px 20px;
		}

		.chat-input-group {
			display: flex;
			gap: 10px;
			background: var(--bg-warm);
			padding: 0.5rem;
			border-radius: 50px;
			border: 1px solid var(--border-color);
		}

		.chat-input {
			flex: 1;
			border: none;
			background: transparent;
			padding: 0.5rem 1rem;
			outline: none;
			font-size: 0.95rem;
		}

		.btn-send {
			width: 40px;
			height: 40px;
			border-radius: 50%;
			background: var(--primary);
			color: var(--white);
			border: none;
			display: flex;
			align-items: center;
			justify-content: center;
			cursor: pointer;
			transition: background 0.2s;
		}

		.btn-send:hover {
			background: var(--primary-dark);
		}

		/* 반응형 처리 */
		@media (max-width: 992px) {
			.friend-section.shrink {
				flex: 0 0 320px;
			}

			.chat-section {
				width: calc(100% - 320px - 3.5rem);
			}
		}

		@media (max-width: 768px) {
			body {
				padding-top: 80px;
				/* 모바일에서는 네비바 높이가 작을 수 있음 */
			}

			.main-container {
				padding: 1rem;
				height: calc(100vh - 100px);
			}

			/* 모바일에서는 친구목록이 완전히 사라지거나 오버레이 */
			.friend-section.shrink {
				display: none;
			}

			.chat-section {
				width: 100%;
				right: 0;
				top: 0;
				bottom: 0;
				height: 100%;
				border-radius: 0;
				transform: translateX(100%);
			}

			.chat-section.active {
				position: fixed;
				z-index: 1000;
				transform: translateX(0);
			}

			.chat-header {
				border-radius: 0;
			}

			.chat-footer {
				border-radius: 0;
			}
		}
	</style>
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>

	<div th:replace="~{include/navibar :: header-nav}"></div>

	<div class="main-container">
		<div class="friend-section" id="friendSection">
			<div class="section-header">
				<div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
					<div class="flex-shrink-0">
						<span class="section-title-text"><i class="bi bi-person-heart me-2"></i>내 친구 목록</span>
						<span class="badge rounded-pill bg-secondary ms-2" th:text="${#lists.size(friendList)}">0</span>
					</div>
					<div class="d-flex gap-2 flex-wrap">
						<button class="btn btn-sm btn-outline-secondary" th:onclick="copyMyUuid([[${myUuid}]])">
							<i class="bi bi-clipboard-check"></i> 내 코드 복사
						</button>
						<button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addFriendModal">
							<i class="bi bi-plus-lg"></i> 친구 추가
						</button>
						<button class="btn btn-sm btn-outline-danger position-relative" data-bs-toggle="modal" data-bs-target="#requestModal">
							<i class="bi bi-envelope-heart"></i> 받은 요청
							<span th:if="${!requestList.isEmpty()}" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" th:text="${#lists.size(requestList)}">
							</span>
						</button>
					</div>
				</div>
			</div>


			<div class="friend-list-wrapper">
				<div th:if="${#lists.isEmpty(friendList)}" class="text-center py-5">
					<p class="text-muted">아직 등록된 친구가 없습니다.</p>
				</div>

				<div class="friend-card" th:each="friend : ${friendList}">
					<img th:src="${friend.image == null or friend.image == ''} ? '/img/profile/default.png' : @{|/img/profile/${friend.image}|}" 
					     class="friend-avatar" alt="프로필">
					     
					<div class="friend-info">
						<div class="friend-name" th:text="${friend.name}"></div>
						<div class="friend-status">오늘 날씨가 참 좋네요! ☀️</div>
					</div>
					<div class="friend-actions">
						<button class="btn-action btn-chat" th:onclick="openChat([[${friend.name}]], [[${friend.id}]], [[${friend.image}]], [[${friend.username}]])">
							<i class="bi bi-chat-dots-fill me-1"></i>채팅
						</button>
						
						<button class="btn-action btn-delete" th:onclick="confirmDelete([[${friend.id}]])">
							<i class="bi bi-person-x-fill"></i>
						</button>
					</div>
				</div>
			</div>
		</div>

		<div class="chat-section" id="chatSection">
			<div class="chat-header">
				<div class="chat-user-info">
					<img src="" id="chatAvatar" class="friend-avatar" style="width: 35px; height: 35px;" alt="">
					<span id="chatUserName">사용자 이름</span>
				</div>
				<button class="btn-close-chat" onclick="closeChat()">
					<i class="bi bi-x-lg"></i>
				</button>
			</div>

			<div class="chat-body" id="chatBody">
				</div>

			<div class="chat-footer">
				<div class="chat-input-group">
					<input type="text" class="chat-input" id="messageInput" placeholder="메시지를 입력하세요..."
						onkeypress="handleEnter(event)">
					<button class="btn-send" onclick="sendMessage()">
						<i class="bi bi-send-fill"></i>
					</button>
				</div>
			</div>
		</div>
	</div>
	
	<div class="modal fade" id="addFriendModal" tabindex="-1" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title fw-bold">친구 추가</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<p class="text-muted mb-2">친구의 UUID 코드를 입력하세요.</p>
					<input type="text" id="targetUuid" class="form-control" placeholder="xxxxxxxx-xxxx-xxxx...">
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
					<button type="button" class="btn btn-primary" onclick="requestFriend()">요청 보내기</button>
				</div>
			</div>
		</div>
	</div>
	
	<div class="modal fade" id="requestModal" tabindex="-1" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title fw-bold">받은 친구 요청</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body">
					<div th:if="${#lists.isEmpty(requestList)}" class="text-center py-4 text-muted">
						새로운 친구 요청이 없습니다.
					</div>

					<div th:each="req : ${requestList}"
						class="d-flex align-items-center justify-content-between mb-3 border-bottom pb-2">
						<div class="d-flex align-items-center">
							<img th:src="${req.image == null or req.image == ''} ? '/img/profile/default.png' : @{|/img/profile/${req.image}|}" 
							     class="rounded-circle me-2"
								style="width:40px; height:40px; object-fit:cover;">
							<span class="fw-bold" th:text="${req.name}">이름</span>
						</div>
						<div>
							<button class="btn btn-sm btn-primary"
								th:onclick="respondFriend([[${req.id}]], 'accept')">수락</button>
							<button class="btn btn-sm btn-secondary"
								th:onclick="respondFriend([[${req.id}]], 'refuse')">거절</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script>
	    // 1. 전역 변수 설정
	    const friendSection = document.getElementById('friendSection');
	    const chatSection = document.getElementById('chatSection');
	    const chatUserName = document.getElementById('chatUserName');
	    const chatAvatar = document.getElementById('chatAvatar');
	    const chatBody = document.getElementById('chatBody');
	    const messageInput = document.getElementById('messageInput');

	    let stompClient = null;
	    let currentRoomId = null;
        let currentRecipientUsername = null; // recipient's username for friend chats
	    // 타임리프로 현재 로그인한 사용자 아이디 가져오기
	    const myUsername = "[[${#authentication.principal.username}]]"; 

	    // CSRF 토큰 (AJAX 요청용)
	    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
	    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');


	    // 2. 채팅방 열기 (서버 연결 포함)
	    function openChat(name, friendId, imageUrl, friendUsername) {
            console.log("채팅 열기 시도: ", name, friendId, imageUrl, friendUsername);
            currentRecipientUsername = friendUsername; // Set recipient for notifications

	        // UI 열기
	        friendSection.classList.add('shrink');
	        chatSection.classList.add('active');
	        chatUserName.innerText = name;
	        
            // [수정] 친구 프로필 이미지 설정
			if (imageUrl) {
				chatAvatar.src = '/img/profile/' + imageUrl;
			} else {
				chatAvatar.src = '/img/profile/default.png';
			}
	        // 기존 연결 끊기
	        if (stompClient !== null) {
	            stompClient.disconnect();
	        }
	        
	        // 채팅창 비우기
	        chatBody.innerHTML = '';

	        // [핵심] 서버에서 방 번호 조회 및 이전 대화 가져오기
	        fetch('/friend/chat/room', {
	            method: 'POST',
	            headers: {
	                'Content-Type': 'application/x-www-form-urlencoded',
	                [csrfHeader]: csrfToken
	            },
	            body: 'friendId=' + friendId
	        })
	        .then(res => res.json())
	        .then(data => {
	            currentRoomId = data.roomId;
	            
	            // 과거 내역 출력
	            if(data.history) {
	                data.history.forEach(msg => displayMessage(msg));
	            }

	            // 웹소켓 연결 시작
	            connectStomp(currentRoomId);
	        })
	        .catch(err => {
	            console.error("채팅방 접속 실패:", err);
	            alert("채팅방을 불러오지 못했습니다.");
	        });

	        // 모바일 대응
	        if (window.innerWidth <= 768) {
	            document.body.style.overflow = 'hidden';
	        }
	    }

	    // 3. 웹소켓(Stomp) 연결 함수
	    function connectStomp(roomId) {
	        var socket = new SockJS('/ws-stomp'); // 서버의 WebSocket 엔드포인트
	        stompClient = Stomp.over(socket);
	        stompClient.debug = null; // 디버그 로그 끄기

	        stompClient.connect({}, function (frame) {
	            console.log('Connected: ' + frame);
	            
	            // 해당 방 구독 (메시지 수신 대기)
	            stompClient.subscribe('/sub/chat/room/' + roomId, function (chatMessage) {
	                var message = JSON.parse(chatMessage.body);
	                displayMessage(message);
	            });
	        });
	    }

	    // 4. 메시지 전송 (실제 전송)
	    function sendMessage() {
	        const message = messageInput.value.trim();

	        if (message && stompClient && currentRoomId) {
	            var chatMessage = {
	                roomId: currentRoomId,
	                sender: myUsername,
	                message: message,
	                messageType: 'TALK',
                    recipientUsername: currentRecipientUsername // Add recipient username
	            };
	            
	            // 서버로 전송 (/pub)
	            stompClient.send("/pub/chat/message", {}, JSON.stringify(chatMessage));
	            messageInput.value = '';
	        }
	    }

	    // 5. 화면에 메시지 그리기
	    function displayMessage(msg) {
	        const bubble = document.createElement('div');
	        
	        // 내가 보낸 것 vs 남이 보낸 것 구분
	        if (msg.sender === myUsername) {
	            bubble.className = 'chat-bubble sent';
	        } else {
	            bubble.className = 'chat-bubble receive';
	        }
	        
	        bubble.innerText = msg.message;
	        chatBody.appendChild(bubble);
	        chatBody.scrollTop = chatBody.scrollHeight; // 스크롤 하단 이동
	    }

	    // 6. 채팅방 닫기
	    function closeChat() {
	        friendSection.classList.remove('shrink');
	        chatSection.classList.remove('active');
            currentRecipientUsername = null; // Reset recipient

	        // 연결 해제
	        if (stompClient !== null) {
	            stompClient.disconnect();
	            stompClient = null;
	        }

	        if (window.innerWidth <= 768) {
	            document.body.style.overflow = 'auto';
	        }
	    }

	    function handleEnter(e) {
	        if (e.key === 'Enter') {
	            sendMessage();
	        }
	    }


	    // --- 아래는 기존 친구 관리 기능 (그대로 유지) ---

	    // 친구 삭제 확인 (기능 구현 필요)
	    function confirmDelete(friendId) {
	        if (confirm("정말로 이 친구를 목록에서 삭제하시겠습니까?")) {
	            deleteFriend(friendId);
	        }
	    }
	    
	    // 친구 삭제
	    function deleteFriend(friendId) {
	        fetch('/friend/delete', {
	            method: 'POST',
	            headers: {
	                'Content-Type': 'application/x-www-form-urlencoded',
	                [csrfHeader]: csrfToken
	            },
	            body: 'friendId=' + friendId
	        })
	        .then(response => response.text())
	        .then(status => {
	            if (parseInt(status) === 1) {
	                alert("친구가 삭제되었습니다.");
	                location.reload();
	            } else {
	                alert("친구 삭제에 실패했습니다.");
	            }
	        })
	        .catch(error => {
	            console.error('Error:', error);
	            alert("서버 통신 중 오류가 발생했습니다.");
	        });
	    }

	    // 친구 추가 요청
	    function requestFriend() {
	        const uuidInput = document.getElementById('targetUuid');
	        const uuid = uuidInput.value.trim();
	        
	        if(!uuid) {
	            alert("UUID를 입력해주세요.");
	            return;
	        }

	        fetch('/friend/request', {
	            method: 'POST',
	            headers: {
	                'Content-Type': 'application/x-www-form-urlencoded',
	                [csrfHeader]: csrfToken
	            },
	            body: 'uuid=' + encodeURIComponent(uuid)
	        })
	        .then(response => response.text())
	        .then(status => {
	            const code = parseInt(status);
	            if (code === 1) {
	                alert("친구 요청을 보냈습니다!");
	                location.reload();
	            } else if (code === -1) {
	                alert("존재하지 않는 사용자입니다.");
	            } else if (code === -2) {
	                alert("자기 자신에게는 보낼 수 없습니다.");
	            } else if (code === -3) {
	                alert("이미 요청 대기 중이거나 받은 상태입니다.");
	            } else if (code === -5) {
	                alert("이미 친구 사이입니다.");
	            } else {
	                alert("오류가 발생했습니다.");
	            }
	        })
	        .catch(error => {
	            console.error('Error:', error);
	            alert("서버 통신 중 오류가 발생했습니다.");
	        });
	    }

	    // 친구 수락/거절
	    function respondFriend(friendId, type) {
	        const url = (type === 'accept') ? '/friend/accept' : '/friend/refuse';
	        const msg = (type === 'accept') ? '친구 요청을 수락하시겠습니까?' : '친구 요청을 거절하시겠습니까?';

	        if(!confirm(msg)) return;

	        fetch(url, {
	            method: 'POST',
	            headers: { 
	                'Content-Type': 'application/x-www-form-urlencoded',
	                [csrfHeader]: csrfToken
	            },
	            body: 'friendId=' + friendId
	        })
	        .then(response => response.text())
	        .then(status => {
	            if (parseInt(status) === 1) {
	                alert("처리되었습니다.");
	                location.reload();
	            } else {
	                alert("오류가 발생했습니다.");
	            }
	        })
	        .catch(err => {
	            console.error(err);
	            alert("서버 통신 오류");
	        });
	    }

	    // UUID 복사
	    function copyMyUuid(uuid) {
	        if (!uuid) {
	            alert("UUID 정보를 불러오지 못했습니다.");
	            return;
	        }
	        navigator.clipboard.writeText(uuid)
	            .then(() => {
	                alert("내 친구 코드가 복사되었습니다!\n친구에게 공유하세요.");
	            })
	            .catch(err => {
	                console.error('복사 실패:', err);
	                alert("복사에 실패했습니다.");
	            });
	    }
	</script>

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>

</html>