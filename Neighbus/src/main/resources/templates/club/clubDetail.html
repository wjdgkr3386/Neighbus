<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title th:text="|${club.clubName} - 동네친구|">동아리 상세 - 동네친구</title>

	<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;500;600;700;800&display=swap"
		rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

	<style>
		:root {
			--primary-color: #F97316;
			--accent-color: #F97316;
			--background-color: #F8FAFC;
			--text-primary: #1E293B;
			--text-secondary: #64748B;
			--border-color: #E2E8F0;
			--card-bg: #FFFFFF;
		}

		/* ... (기존 스타일은 동일) ... */
		body {
			font-family: 'Pretendard', sans-serif;
			background: var(--background-color);
			color: var(--text-primary);
		}

		body.is-popup .header {
			display: none;
		}

		body.is-popup .container {
			margin: 0;
			padding: 20px;
		}

		body.is-popup .detail-card {
			border-radius: 16px;
			box-shadow: none;
		}

		.header {
			background: #FFFFFF;
			border-bottom: 1px solid var(--border-color);
			box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
		}

		.header-container {
			max-width: 1200px;
			margin: 0 auto;
			padding: 0 20px;
			display: flex;
			justify-content: space-between;
			align-items: center;
			height: 80px;
		}

		.logo img {
			height: 50px;
		}

		.container {
			max-width: 800px;
			margin: 40px auto;
			padding: 20px;
		}

		.detail-card {
			background: var(--card-bg);
			border-radius: 24px;
			box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
			overflow: hidden;
		}

		.detail-image {
			width: 100%;
			height: 400px;
			object-fit: cover;
		}

		.detail-content {
			padding: 40px;
		}

		.detail-category {
			display: inline-block;
			padding: 6px 14px;
			background: #FFF7ED;
			color: var(--primary-color);
			border-radius: 8px;
			font-size: 14px;
			font-weight: 700;
			margin-bottom: 15px;
		}

		.detail-title {
			font-size: 32px;
			font-weight: 800;
			margin-bottom: 20px;
		}

		.detail-meta {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 15px;
			margin-bottom: 30px;
			padding-bottom: 30px;
			border-bottom: 1px solid var(--border-color);
		}

		.meta-item {
			display: flex;
			align-items: center;
			gap: 12px;
			font-size: 16px;
			color: var(--text-secondary);
		}

		.meta-item i {
			font-size: 20px;
			color: var(--primary-color);
		}

		.detail-description {
			font-size: 16px;
			line-height: 1.8;
			color: var(--text-primary);
			margin-bottom: 40px;
			white-space: pre-wrap;
		}

		.join-button {
			display: block;
			width: 100%;
			padding: 18px;
			background: var(--accent-color);
			color: white;
			border: none;
			border-radius: 12px;
			font-size: 18px;
			font-weight: 700;
			cursor: pointer;
			/* transition 속성 제거 */
			text-decoration: none;
			text-align: center;
		}

		.join-button:hover {
			transform: translateY(-3px);
			box-shadow: 0 8px 20px rgba(249, 115, 22, 0.3);
		}

		/* ★ 수정된 부분: 탈퇴 버튼 스타일 추가 */
		.withdraw-button {
			display: block;
			width: 100%;
			padding: 18px;
			background: #EF4444;
			/* 탈퇴 버튼 (빨간색) */
			color: white;
			border: none;
			border-radius: 12px;
			font-size: 18px;
			font-weight: 700;
			cursor: pointer;
			text-decoration: none;
			text-align: center;
		}

		.withdraw-button:hover {
			background: #DC2626;
			/* 호버 시 더 진한 빨간색 */
			transform: translateY(-3px);
			box-shadow: 0 8px 20px rgba(220, 38, 38, 0.3);
		}

		/* ... (alert 스타일 동일) ... */
		.alert {
			padding: 15px 20px;
			border-radius: 12px;
			font-size: 16px;
			font-weight: 600;
			margin: 0 auto 20px auto;
			/* 상세 카드 위에 보이도록 수정 */
		}

		.alert-success {
			background: #DCFCE7;
			/* 연한 녹색 */
			color: #16A34A;
			/* 진한 녹색 */
			border: 1px solid #BCF0C1;
		}

		.alert-error {
			background: #FEF2F2;
			/* 연한 빨강 */
			color: #EF4444;
			/* 진한 빨강 */
			border: 1px solid #FCDEDF;
		}

		/* 팝업일 때 적용될 스타일 */
		body.is-popup .container {
			max-width: 100%;
			margin: 0;
			padding: 0;
		}
		body.is-popup .detail-card {
			border-radius: 0;
			box-shadow: none;
			height: 100vh; /* 팝업 높이를 꽉 채움 */
			display: flex;
			flex-direction: column;
		}
		body.is-popup .detail-image {
			height: 45%; /* 이미지 높이를 팝업의 45%로 조정 */
			object-fit: cover;
		}
		body.is-popup .detail-content {
			padding: 25px; /* 내부 여백 축소 */
			flex-grow: 1;
			overflow-y: auto; /* 내용이 길어지면 스크롤 */
		}
	</style>
</head>

<body>
	<div class="container">

		<div th:if="${successMessage}" class="alert alert-success">
			<span th:text="${successMessage}"></span>
		</div>

		<div th:if="${errorMessage}" class="alert alert-error">
			<span th:text="${errorMessage}"></span>
		</div>

	</div>

	<div class="container">
		<div class="detail-card" th:if="${club != null}">

			<img src="https://images.unsplash.com/photo-1511632765486-a01980e01a18?w=800" alt="동아리 이미지"
				class="detail-image">

			<div class="detail-content">

				<span class="detail-category" th:text="${club.cityName}">시</span>

				<h1 class="detail-title" th:text="${club.clubName}">동아리 이름</h1>

				<div class="detail-meta">
					<div class="meta-item">
						<i class="fa-solid fa-location-dot"></i>
						<span th:text="${club.provinceName}">지역(도)</span>
					</div>

					<div class="meta-item">
						<i class="fa-solid fa-calendar-days"></i>
						<span th:text="${#temporals.format(club.createdAt, 'yyyy-MM-dd')}">생성일</span>
					</div>

				</div>
				<p class="detail-description" th:text="${club.clubInfo}">
					동아리 상세 설명입니다. (${club.clubInfo} 값이 있으면 이 텍스트는 대체됩니다.)
				</p>

				<div th:if="${isLoggedIn AND !isMember}">
					<form th:action="@{/club/join/{id}(id=${club.id})}" method="post" style="margin: 0;">
						<button type="submit" class="join-button">동아리 가입하기</button>
					</form>
				</div>

				<div th:if="${isLoggedIn AND isMember}">
					<form th:action="@{/club/withdraw/{clubId}(clubId=${club.id})}" method="post" style="margin: 0;"
						onsubmit="return handleWithdraw(event);">
						<button type="submit" class="withdraw-button">동아리 탈퇴하기</button>
					</form>
				</div>
				<div th:if="${!isLoggedIn}">
					<a th:href="@{/login}" class="join-button" style="text-align: center;">
						로그인 후 가입해주세요
					</a>
				</div>
			</div>
		</div>

		<div th:if="${club == null}">
			<h1>해당 동아리 정보를 찾을 수 없습니다.</h1>
		</div>
	</div>

	<script>
		document.addEventListener('DOMContentLoaded', function () {
			const urlParams = new URLSearchParams(window.location.search);
			if (urlParams.get('popup') === 'true') {
				document.body.classList.add('is-popup');
			}
		});

		/**
		 * 동아리 탈퇴 처리를 비동기(AJAX)로 수행하고 팝업을 닫는 함수
		 */
		async function handleWithdraw(event) {
			// 1. 기본 폼 제출(새로고침)을 막습니다.
			event.preventDefault();

			// 2. 탈퇴 의사를 다시 확인합니다.
			if (confirm('정말 이 동아리를 탈퇴하시겠습니까?')) {
				const form = event.target;
				const url = form.action;
				
				// 3. 폼 데이터를 가져옵니다. (CSRF 토큰이 있다면 함께 포함됩니다)
				const formData = new FormData(form);

				try {
					// 4. fetch API를 사용해 서버에 POST 요청을 보냅니다.
					const response = await fetch(url, {
						method: 'POST',
						body: formData 
					});

					// 5. 서버 응답이 성공적이면
					if (response.ok) {
						// 6. (중요) 팝업을 연 부모(opener) 창을 새로고침합니다.
						if (window.opener && window.opener.location) {
							window.opener.location.reload();
						}
						
						// 7. (중요) 현재 팝업 창을 닫습니다.
						window.close();
					} else {
						// 8. 서버에서 오류가 발생한 경우
						alert('탈퇴 처리에 실패했습니다. 다시 시도해주세요.');
					}
				} catch (error) {
					// 9. 네트워크 오류 등이 발생한 경우
					console.error('탈퇴 처리 중 오류:', error);
					alert('탈퇴 처리 중 오류가 발생했습니다.');
				}
			}
			
			// 2번에서 '취소'를 누른 경우 false를 반환하여 폼 제출을 중단합니다.
			return false;
		}
	</script>
	</body>

</html>