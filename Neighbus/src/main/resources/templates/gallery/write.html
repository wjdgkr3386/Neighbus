<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title th:text="${isEdit} ? '글 수정 - 동네친구' : '글 쓰기 - 동네친구'">글 쓰기 - 동네친구</title>
    
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    
    <link href="https://cdn.jsdelivr.net/gh/sunn-us/SUIT/fonts/static/woff2/SUIT.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="/css/navibar.css">
    <link rel="stylesheet" href="/css/custom-modal.css">

    <style>
        :root {
            --primary: #A67C52; --primary-dark: #8D6E63; --bg-ivory: #FFF8F0; --bg-warm: #FFF5EB; --bg-cream: #FAF0E6;
            --card-bg: #FFFBF7; --text-primary: #5D4037; --text-secondary: #8D6E63; --border-color: #E8D7C3;
            --shadow-color: rgba(166, 124, 82, 0.1); --white: #FFFFFF;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'SUIT', sans-serif; 
            background: linear-gradient(165deg, var(--bg-ivory) 0%, var(--bg-warm) 50%, var(--bg-cream) 100%); 
            color: var(--text-primary); min-height: 100vh; padding-bottom: 60px; padding-top: 80px; word-break: keep-all; 
        }
        .container { max-width: 900px; margin: 0 auto; padding: 40px 20px; }
        .page-header { margin-bottom: 30px; text-align: center; }
        .page-header h1 { font-size: 2.5rem; font-weight: 800; color: var(--text-primary); }
        .write-container { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 20px; padding: 40px; box-shadow: 0 8px 25px var(--shadow-color); }
        .form-group { margin-bottom: 25px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; }
        input[type="text"], textarea, select { width: 100%; padding: 14px 18px; border: 1px solid var(--border-color); border-radius: 12px; font-size: 1rem; background: var(--white); }
        textarea { min-height: 250px; resize: none; }
        
        /* 파일 업로드 영역 & 드래그 효과 */
        .file-upload-area { border: 2px dashed var(--border-color); border-radius: 16px; padding: 40px 20px; text-align: center; background: var(--bg-cream); cursor: pointer; transition: all 0.3s ease; }
        .file-upload-area.drag-over { border-color: var(--primary); background: var(--bg-warm); transform: scale(1.02); }
        
        .preview-container { margin-top: 20px; display: grid; gap: 12px; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); }
        .preview-item { position: relative; border-radius: 12px; overflow: hidden; aspect-ratio: 1; border: 1px solid var(--border-color); }
        .preview-image { width: 100%; height: 100%; object-fit: cover; }
        .remove-image { position: absolute; top: 5px; right: 5px; width: 24px; height: 24px; background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .button-group { display: flex; gap: 12px; justify-content: flex-end; margin-top: 40px; }
        .btn { padding: 14px 30px; border-radius: 12px; font-weight: 700; cursor: pointer; border: none; text-decoration: none; display: inline-flex; align-items: center; }
        .btn-secondary { background: var(--bg-cream); color: var(--text-secondary); border: 1px solid var(--border-color); }
        .btn-accent { background: var(--primary); color: white; }

        @media (max-width: 768px) {
            .page-header h1 { font-size: 1.8rem; }
            .write-container { padding: 20px; }
            .preview-container { grid-template-columns: repeat(3, 1fr); }
            .button-group { flex-direction: column-reverse; }
            .btn { width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>
    <div th:replace="~{include/navibar :: header-nav}"></div>

    <div class="container">
        <div class="page-header">
            <h1 th:text="${isEdit} ? '글 수정하기' : '글 쓰기'">글 쓰기</h1>
            <p th:text="${isEdit} ? '이야기를 수정하고 사진을 관리하세요.' : '새로운 소식을 들려주세요.'"></p>
        </div>

        <div class="write-container">
            <form id="galleryForm">
                <input type="hidden" id="username" th:value="${username}">
                <input type="hidden" id="isEdit" th:value="${isEdit}">
                <input th:if="${isEdit}" type="hidden" id="galleryId" th:value="${galleryMap['ID']}">
                
                <div th:if="${!isEdit}" class="form-group">
                    <label>동아리 선택</label>
                    <select id="clubSelect" name="clubId" required>
                        <option value="">글을 작성할 동아리를 선택하세요</option>
                        <option th:each="myClub : ${myClubList}" th:value="${myClub.id}" th:text="${myClub.clubName}"></option>
                    </select>
                </div>
                <input th:if="${isEdit}" type="hidden" id="clubSelect" name="clubId" th:value="${galleryMap['CLUB_ID']}">

                <div class="form-group">
                    <label>제목 <span style="color:red;">*</span></label>
                    <input type="text" id="title" th:value="${galleryMap != null ? galleryMap['TITLE'] : ''}" placeholder="제목을 입력하세요">
                </div>

                <div class="form-group">
                    <label>내용 <span style="color:red;">*</span></label>
                    <textarea id="content" th:utext="${galleryMap != null ? galleryMap['CONTENT'] : ''}" placeholder="내용을 입력하세요."></textarea>
                </div>

                <div class="form-group">
                    <label>사진 첨부 (클릭하거나 사진을 끌어다 놓으세요)</label>
                    <div class="file-upload-area" id="uploadArea">
                        <i class="bi bi-cloud-arrow-up-fill" style="font-size: 2.5rem; color: var(--primary);"></i>
                        <p class="mt-2">JPG, PNG, GIF 파일</p>
                        <input type="file" id="fileInput" accept="image/*" multiple style="display:none;">
                    </div>
                    <div class="preview-container" id="previewContainer">
                        <th:block th:if="${isEdit and galleryMap.IMAGES != null}">
                            <div th:each="img : ${galleryMap.IMAGES}" 
                                 class="existing-image-data"
                                 th:attr="data-img-path=${img.IMG}, data-img-id=${img.ID}" style="display:none;">
                            </div>
                        </th:block>
                    </div>
                </div>

                <div class="button-group">
                    <a th:href="${isEdit} ? @{|/gallery/detail/${galleryMap['ID']}|} : @{/gallery}" class="btn btn-secondary">취소</a>
                    <button type="button" class="btn btn-accent" onclick="submitGallery()">
                        <i class="bi bi-check-lg me-2"></i>
                        <span th:text="${isEdit} ? '수정 완료' : '등록 하기'"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script th:inline="javascript">
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const previewContainer = document.getElementById('previewContainer');
        const isEditValue = document.getElementById('isEdit').value === 'true';
        let fileList = [];
		let existingPathList = [];
		let deletedExistingPathList = [];
		
        // 1. 초기화: 수정 시 기존 이미지 파일화 및 선택 처리
		document.addEventListener('DOMContentLoaded', async () => {
		    if (isEditValue) {
		        const existingImages = document.querySelectorAll('.existing-image-data');
		        for (const imgData of existingImages) {
		            const path = imgData.getAttribute('data-img-path');
		            const id = imgData.getAttribute('data-img-id');
		            
		            existingPathList.push(path); // 경로를 리스트에 추가
		            
		            try {
		                createPreview(path, id, true); // 미리보기 생성
		                const res = await fetch(path);
		                const blob = await res.blob();
		                const file = new File([blob], "old_" + id, { type: blob.type });
		                file.isExisting = true;
		                file.id = id;
		                fileList.push(file); // 선택된 리스트에 추가
		            } catch (e) { console.error("기존 이미지 로드 실패", e); }
		        }
		    }
		});

        // 2. 드래그 앤 드롭 이벤트 설정
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt => {
            uploadArea.addEventListener(evt, (e) => {
                e.preventDefault();
                e.stopPropagation();
            });
        });

        ['dragenter', 'dragover'].forEach(evt => {
            uploadArea.addEventListener(evt, () => uploadArea.classList.add('drag-over'));
        });

        ['dragleave', 'drop'].forEach(evt => {
            uploadArea.addEventListener(evt, () => uploadArea.classList.remove('drag-over'));
        });

        uploadArea.addEventListener('drop', (e) => {
            const files = e.dataTransfer.files;
            handleFiles(files);
        });

        uploadArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

        // 3. 파일 처리 공통 함수
        function handleFiles(files) {
            Array.from(files).forEach(file => {
                if (!file.type.startsWith('image/')) return;
                file.tempId = 'new_' + Date.now() + Math.random();
                fileList.push(file);
                
                const reader = new FileReader();
                reader.onload = (e) => createPreview(e.target.result, file.tempId, false);
                reader.readAsDataURL(file);
            });
            fileInput.value = ''; 
        }

        // 4. 미리보기 생성
        function createPreview(src, identifier, isExisting = false) {
            const div = document.createElement('div');
            div.className = 'preview-item';
            div.dataset.identifier = identifier;
            div.dataset.isExisting = isExisting;
            div.innerHTML = `
                <img src="${src}" class="preview-image">
                <button type="button" class="remove-image" onclick="previewRemove(event)">
                    <i class="bi bi-x"></i>
                </button>
            `;
            previewContainer.appendChild(div);
        }

        // 5. 삭제 처리
		function previewRemove(event) {
		    const item = event.target.closest('.preview-item');
		    const id = item.dataset.identifier;
		    const isExisting = item.dataset.isExisting === 'true';

		    if (isExisting) {
		        // img 태그의 src(경로)를 찾습니다.
		        const path = item.querySelector('img').getAttribute('src');
		        
		        // deletedExistingPathList에 삭제된 경로 추가
		        deletedExistingPathList.push(path);
		        
		        // existingPathList에서 제거
		        existingPathList = existingPathList.filter(p => p !== path);
		    }

		    fileList = fileList.filter(f => isExisting ? f.id !== id : f.tempId !== id);
		    item.remove();
		}

		// 6. 데이터 제출
		function submitGallery() {
		    const title = document.getElementById("title").value.trim();
		    const content = document.getElementById("content").value.trim();
		    const clubId = document.getElementById("clubSelect").value;
		    
		    if(!title || !content || !clubId) { alert("필수 항목을 모두 입력해주세요."); return; }

		    if(fileList.length === 0 && existingPathList.length === 0) { 
		        alert("사진을 최소 1장 등록해주세요."); 
		        return; 
		    }

		    const formData = new FormData();
		    formData.append("title", title);
		    formData.append("content", content);
		    formData.append("clubId", clubId);
		    formData.append("username", document.getElementById("username").value);
		    if(isEditValue) formData.append("galleryId", document.getElementById("galleryId").value);

		    existingPathList.forEach(path => formData.append("existingPathList", path));
		    
		    // 명령 수행: 삭제된 이미지 경로 리스트를 서버로 전송
		    deletedExistingPathList.forEach(path => formData.append("deletedExistingPathList", path));

		    fileList.forEach(file => formData.append("fileList", file));

		    const csrfToken = document.querySelector("meta[name='_csrf']").getAttribute("content");
		    const csrfHeader = document.querySelector("meta[name='_csrf_header']").getAttribute("content");

		    fetch(isEditValue ? "/gallery/api/updateGallery" : "/gallery/api/insertGallery", {
		        method: "POST",
		        headers: { [csrfHeader]: csrfToken },
		        body: formData
		    })
		    .then(res => res.json())
		    .then(data => {
		        if(data.status === 1) {
		            alert("저장되었습니다.");
		            window.location.href = isEditValue ? `/gallery/detail/${document.getElementById("galleryId").value}` : "/gallery";
		        } else {
		            alert(data.message || "오류 발생");
		        }
		    });
		}
    </script>
    <script src="/js/custom-modal.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>