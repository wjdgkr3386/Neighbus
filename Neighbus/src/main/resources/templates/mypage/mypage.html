<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>마이페이지 - NEIGHBUS</title>
	
	<link href="https://cdn.jsdelivr.net/gh/sunn-us/SUIT/fonts/static/woff2/SUIT.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
	<link rel="stylesheet" href="/css/navibar.css">
    <link rel="stylesheet" href="/css/bottom-navbar.css">
	<link rel="stylesheet" href="/css/custom-modal.css">
    <script src="/js/custom-modal.js"></script>

	<style>
		:root {
			--primary: #A67C52; --primary-dark: #8D6E63; --primary-light: #C9A88A;
			--bg-ivory: #FFF8F0; --bg-warm: #FFF5EB; --bg-cream: #FAF0E6;
			--card-bg: #FFFBF7; --text-primary: #5D4037; --text-secondary: #8D6E63;
			--text-light: #A1887F; --border-color: #E8D7C3; --shadow-color: rgba(166, 124, 82, 0.08);
			--white: #FFFFFF;
		}

		* { margin: 0; padding: 0; box-sizing: border-box; }
		body {
			font-family: 'SUIT', sans-serif;
			background: linear-gradient(165deg, var(--bg-ivory) 0%, var(--bg-warm) 50%, var(--bg-cream) 100%);
			color: var(--text-primary);
			padding: 120px 20px 100px 20px;
			min-height: 100vh;
		}

		.container { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 320px 1fr; gap: 30px; }

		/* Profile Card */
		.profile-card {
			background-color: var(--card-bg); border-radius: 24px;
			box-shadow: 0 4px 20px var(--shadow-color); padding: 30px;
			text-align: center; height: fit-content; border: 1px solid var(--border-color);
		}
		.profile-image-wrapper { position: relative; width: 140px; height: 140px; margin: 0 auto 20px; cursor: pointer; }
		.profile-image { width: 140px; height: 140px; border-radius: 50%; object-fit: cover; border: 5px solid var(--white); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
		.profile-name { font-size: 24px; font-weight: 800; margin-bottom: 5px; }
		.profile-nickname { font-size: 16px; color: var(--text-secondary); margin-bottom: 20px; }
		
		.btn-action { display: block; width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 12px; font-weight: 700; text-decoration: none; transition: 0.3s; font-size: 15px; border: none; cursor: pointer; }
		.btn-edit { background: var(--primary); color: white; }
		.btn-outline { background: white; color: var(--primary); border: 1px solid var(--primary); }
		.btn-del { background: #fff1f1; color: #c87e7e; }

		/* Main Content */
		.main-content { background-color: var(--card-bg); border-radius: 24px; padding: 40px; box-shadow: 0 4px 20px var(--shadow-color); border: 1px solid var(--border-color); }
		.tabs { display: flex; gap: 10px; border-bottom: 2px solid var(--bg-warm); margin-bottom: 30px; overflow-x: auto; }
		.tab-link { padding: 12px 20px; cursor: pointer; font-weight: 700; color: var(--text-light); border-bottom: 3px solid transparent; white-space: nowrap; transition: 0.3s; }
		.tab-link.active { color: var(--primary); border-bottom-color: var(--primary); }
		.tab-content { display: none; animation: fadeIn 0.4s ease; }
		.tab-content.active { display: block; }

		/* Info Grid */
		.info-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
		.info-item { background: var(--white); padding: 22px; border-radius: 18px; border: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 8px; }
		.info-label { font-size: 14px; color: var(--text-light); font-weight: 600; display: flex; align-items: center; gap: 8px; }
		.info-value { font-size: 16px; font-weight: 700; color: var(--text-primary); }

		/* Scroll Area */
		.scroll-area {
			max-height: 550px; overflow-y: auto;
			padding-right: 10px; margin-right: -10px;
		}
		.scroll-area::-webkit-scrollbar { width: 6px; }
		.scroll-area::-webkit-scrollbar-track { background: var(--bg-warm); border-radius: 10px; }
		.scroll-area::-webkit-scrollbar-thumb { background: var(--primary-light); border-radius: 10px; }

		.activity-list { display: flex; flex-direction: column; gap: 12px; }
		.activity-item { 
			display: flex; align-items: center; padding: 18px; background: var(--white); 
			border-radius: 16px; border: 1px solid var(--border-color); text-decoration: none; 
			color: inherit; transition: 0.3s;
		}
		.activity-item:hover { transform: translateY(-3px); box-shadow: 0 6px 15px var(--shadow-color); border-color: var(--primary-light); }
		.activity-icon, .club-img { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 18px; flex-shrink: 0; }
		.activity-icon { background: var(--bg-warm); color: var(--primary); font-size: 18px; }
		.club-img { object-fit: cover; }
		.activity-content { flex: 1; min-width: 0; }
		.activity-title { font-size: 16px; font-weight: 800; margin-bottom: 4px; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
		.activity-meta { font-size: 12px; color: var(--text-light); }
		.activity-date { font-size: 12px; color: var(--text-light); margin-left: 15px; flex-shrink: 0; }

		@media (max-width: 991px) { .container { grid-template-columns: 1fr; } .scroll-area { max-height: 450px; } }
		@media (max-width: 768px) { .main-content { padding: 30px 15px; } .info-grid { grid-template-columns: 1fr; } .activity-item { padding: 15px; } }
		@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
	</style>
</head>

<body>
	<div th:replace="~{include/navibar :: header-nav}"></div>

	<div class="container">
		<aside class="profile-card">
			<div class="profile-image-wrapper" onclick="document.getElementById('profileImageInput').click()">
				<img th:src="${myInfo.image}" alt="프로필" class="profile-image">
				<div style="position:absolute; bottom:5px; right:5px; background:var(--primary); color:white; width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:14px; border:2px solid white;"><i class="fas fa-camera"></i></div>
			</div>

			<form id="profileImageForm" th:action="@{/mypage/uploadProfileImage}" method="post" enctype="multipart/form-data" class="d-none">
				<input type="file" id="profileImageInput" name="profileImage" accept="image/*" onchange="confirmImageUpload(this)">
			</form>

			<h2 class="profile-name" th:text="${myInfo.name}">이름</h2>
			<p class="profile-nickname" th:text="${myInfo.nickname}">닉네임</p>

			<div class="profile-actions mt-4">
				<button onclick="openEditModal()" class="btn-action btn-edit">프로필 수정</button>
				<a href="/mypage/passwordUpdate" class="btn-action btn-outline">비밀번호 변경</a>
				<form th:action="@{/logout}" method="post"><button type="submit" class="btn-action btn-outline w-100">로그아웃</button></form>
				<button class="btn-action btn-del" onclick="confirmWithdrawal()">회원 탈퇴</button>
				<form id="delUserForm" th:action="@{/mypage/delMyUser}" method="post" class="d-none"></form>
			</div>
		</aside>

		<main class="main-content">
			<div class="tabs">
				<div class="tab-link active" onclick="openTab(event, 'my-info')">내 정보</div>
				<div class="tab-link" onclick="openTab(event, 'my-posts')">작성한 글</div>
				<div class="tab-link" onclick="openTab(event, 'my-comments')">작성한 댓글</div>
				<div class="tab-link" onclick="openTab(event, 'my-clubs')">내 동아리</div>
			</div>

			<div id="my-info" class="tab-content active">
				<div class="info-grid">
					<div class="info-item"><div class="info-label"><i class="bi bi-person-badge"></i> 이름</div><div class="info-value" th:text="${myInfo.name}"></div></div>
					<div class="info-item"><div class="info-label"><i class="bi bi-at"></i> 아이디</div><div class="info-value" th:text="${myInfo.username}"></div></div>
					<div class="info-item"><div class="info-label"><i class="bi bi-calendar-heart"></i> 생년월일</div><div class="info-value" th:text="${myInfo.birth != null ? #strings.substring(myInfo.birth,0,2)+'.'+#strings.substring(myInfo.birth,2,4)+'.'+#strings.substring(myInfo.birth,4,6) : '정보 없음'}"></div></div>
					<div class="info-item"><div class="info-label"><i class="bi bi-geo-alt"></i> 지역</div><div class="info-value" th:text="${myInfo.city}"></div></div>
					<div class="info-item">
						<div class="info-label"><i class="bi bi-telephone"></i> 연락처</div>
						<div class="info-value d-flex align-items-center justify-content-between">
							<span th:text="${#strings.length(myInfo.phone) >= 11 ? #strings.substring(myInfo.phone,0,3) + '-' + #strings.substring(myInfo.phone,3,7) + '-' + #strings.substring(myInfo.phone,7,11) : myInfo.phone}"></span>
						</div>
					</div>
					<div class="info-item"><div class="info-label"><i class="bi bi-person-vcard"></i> 닉네임</div><div class="info-value" th:text="${myInfo.nickname}"></div></div>
					<div class="info-item"><div class="info-label"><i class="bi bi-envelope"></i> 이메일</div><div class="info-value" th:text="${myInfo.email}"></div></div>
					<div class="info-item"><div class="info-label"><i class="bi bi-award"></i> 등급</div><div class="info-value" th:text="${myInfo.grade}"></div></div>
				</div>
			</div>

			<div id="my-posts" class="tab-content">
				<div class="scroll-area">
					<div class="activity-list">
						<a th:each="post : ${myPosts}" th:href="@{${post.postType == 'gallery' ? '/gallery/detail/' + post.postId : '/freeboard/' + post.postId}}" class="activity-item">
							<div class="activity-icon"><i class="fas fa-file-alt"></i></div>
							<div class="activity-content">
								<div class="activity-title" th:text="${post.title}"></div>
								<div class="activity-meta" th:text="${post.postType == 'gallery' ? '갤러리' : '자유게시판'}"></div>
							</div>
							<div class="activity-date" th:text="${#temporals.format(post.createdAt, 'yyyy.MM.dd - HH:mm')}"></div>
						</a>
						<div th:if="${myPosts.isEmpty()}" class="text-center py-5 text-muted">작성한 게시글이 없습니다.</div>
					</div>
				</div>
			</div>

			<div id="my-comments" class="tab-content">
				<div class="scroll-area">
					<div class="activity-list">
						<a th:each="comment : ${myComments}" th:href="@{${comment.commentType == 'gallery' ? '/gallery/detail/' + comment.postId : '/freeboard/' + comment.postId}}" class="activity-item">
							<div class="activity-icon"><i class="fas fa-comment-dots"></i></div>
							<div class="activity-content">
								<div class="activity-title" th:text="${comment.content}"></div>
								<div class="activity-meta" th:text="${comment.commentType == 'gallery' ? '갤러리' : '자유게시판'}"></div>
							</div>
							<div class="activity-date" th:text="${#temporals.format(comment.createdAt, 'yyyy.MM.dd - HH:mm')}"></div>
						</a>
						<div th:if="${myComments.isEmpty()}" class="text-center py-5 text-muted">작성한 댓글이 없습니다.</div>
					</div>
				</div>
			</div>

			<div id="my-clubs" class="tab-content">
				<div class="scroll-area">
					<div class="activity-list">
						<a th:each="club : ${myClubs}" th:href="@{|/club/detail/${club.id}|}" class="activity-item">
							<img th:src="${club.clubImg}" class="club-img" alt="동아리">
							<div class="activity-content">
								<div class="activity-title" th:text="${club.clubName}"></div>
								<div class="activity-meta"><span><i class="bi bi-geo-alt"></i> <span th:text="${club.cityName}"></span></span></div>
							</div>
						</a>
						<div th:if="${myClubs == null or myClubs.isEmpty()}" class="text-center py-5 text-muted">가입한 동아리가 없습니다.</div>
					</div>
				</div>
			</div>
		</main>
	</div>

    <div id="withdrawalModal" class="custom-modal-overlay">
        <div class="custom-modal" style="max-width: 420px;">
            <h4 class="mb-3 fw-bold" style="color: #c87e7e;">회원 탈퇴 확인</h4>
            <p class="text-secondary small mb-4">정말로 탈퇴하시겠습니까?<br>탈퇴를 원하시면 아래에 <b>'회원 탈퇴'</b>를 입력해주세요.</p>
            <input type="text" id="withdrawalInput" class="form-control mb-4 text-center rounded-3" style="height: 50px; font-weight: 700; border: 2px solid #E8D7C3;">
            <div class="d-flex gap-2">
                <button class="btn btn-danger w-100 py-2 fw-bold" onclick="processWithdrawal()">탈퇴하기</button>
                <button class="btn btn-light w-100 py-2 fw-bold" onclick="closeWithdrawalModal()">취소</button>
            </div>
        </div>
    </div>

	<div id="editModal" class="custom-modal-overlay">
		<div class="custom-modal" style="text-align: left; max-width: 450px;">
			<h3 class="mb-4" style="font-weight: 800;">프로필 수정</h3>
			<form th:action="@{/mypage/update}" method="post">
				<div class="mb-3"><label class="form-label small fw-bold">닉네임</label><input type="text" name="nickname" class="form-control" th:value="${myInfo.nickname}" required></div>
				<div class="mb-4">
					<label class="form-label small fw-bold">활동 지역</label>
					<div class="d-flex gap-2">
						<select id="provinceSelect" name="province" class="form-select" required><option value="">시/도</option><option th:each="province : ${provinceList}" th:value="${province.id}" th:text="${province.province}"></option></select>
						<select id="citySelect" name="city" class="form-select" required disabled><option value="">시/군/구</option></select>
					</div>
				</div>
				<div class="d-flex gap-2 mt-4"><button type="submit" class="btn btn-primary w-100 py-2 fw-bold">저장</button><button type="button" class="btn btn-light w-100 py-2 fw-bold" onclick="closeEditModal()">취소</button></div>
			</form>
		</div>
	</div>

	<script th:inline="javascript">
		const regionList = /*[[${regionList}]]*/ [];
		function openTab(evt, tabName) {
			const tabcontent = document.getElementsByClassName("tab-content");
			for (let i = 0; i < tabcontent.length; i++) tabcontent[i].classList.remove("active");
			const tablinks = document.getElementsByClassName("tab-link");
			for (let i = 0; i < tablinks.length; i++) tablinks[i].classList.remove("active");
			document.getElementById(tabName).classList.add("active");
			evt.currentTarget.classList.add("active");
		}
		function openEditModal() { document.getElementById('editModal').classList.add('active'); }
		function closeEditModal() { document.getElementById('editModal').classList.remove('active'); }

		// --- 회원 탈퇴 로직 ---
        function confirmWithdrawal() { 
            document.getElementById('withdrawalInput').value = ''; // 초기화
            document.getElementById('withdrawalModal').classList.add('active'); 
        }
        function closeWithdrawalModal() { document.getElementById('withdrawalModal').classList.remove('active'); }
        function processWithdrawal() {
            const input = document.getElementById('withdrawalInput').value;
            if (input === '회원 탈퇴') {
                document.getElementById('delUserForm').submit();
            } else {
                showModal('error', '입력 오류', '문구가 일치하지 않습니다. 다시 입력해주세요.');
            }
        }

		function confirmImageUpload(input) {
			if (input.files && input.files[0]) {
				showModal('confirm', '사진 변경', '프로필 사진을 변경하시겠습니까?', () => { document.getElementById('profileImageForm').submit(); });
			}
		}

		document.addEventListener("DOMContentLoaded", () => {
			const provinceSelect = document.getElementById('provinceSelect');
			const citySelect = document.getElementById('citySelect');
			provinceSelect.addEventListener('change', function() {
				const pid = parseInt(this.value);
				citySelect.innerHTML = '<option value="">선택</option>';
				regionList.filter(r => r.province === pid).forEach(r => {
					const opt = document.createElement('option');
					opt.value = r.id; opt.textContent = r.city;
					citySelect.appendChild(opt);
				});
				citySelect.disabled = false;
			});
		});
	</script>
    <div th:replace="~{include/bottom-navbar :: bottom-nav}"></div>
</body>
</html>