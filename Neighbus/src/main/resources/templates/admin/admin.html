<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{admin/layout :: layout(pageTitle='대시보드', activeMenu='dashboard', content=~{:: #dashboard-content})}">

<body>
    <div id="dashboard-content">
        <div class="page-header">
            <h1>대시보드</h1>
            <p>사이트의 주요 현황을 한눈에 확인하세요.</p>
        </div>

        <!-- Stat Cards -->
        <div class="stat-cards-grid">
            <div class="stat-card">
                <div class="icon"><i class="fa-solid fa-users"></i></div>
                <div class="info">
                    <p class="title">총 회원 수</p>
                    <p class="value" id="total-users">0</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="icon"><i class="fa-solid fa-user-plus"></i></div>
                <div class="info">
                    <p class="title">오늘 가입자</p>
                    <p class="value" id="today-signups">0</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="icon"><i class="fa-solid fa-file-lines"></i></div>
                <div class="info">
                    <p class="title">총 게시글</p>
                    <p class="value" id="total-posts">0</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="icon"><i class="fa-solid fa-circle-question"></i></div>
                <div class="info">
                    <p class="title">처리 대기 문의</p>
                    <p class="value" id="pending-inquiries">0</p>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="dashboard-grid">
            <div class="content-panel">
                <h3>월별 가입자 수</h3>
                <canvas id="monthlySignupsChart"></canvas>
            </div>
            <div class="content-panel">
                <h3>동아리별 회원 수 (상위 5개)</h3>
                <canvas id="clubMembersChart"></canvas>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                // Chart.js 전역 설정
                Chart.defaults.font.family = "'Pretendard', sans-serif";
                Chart.defaults.color = 'var(--text-secondary)';

                // CSS 변수에서 색상 가져오기
                const rootStyles = getComputedStyle(document.documentElement);
                const colorPrimary = rootStyles.getPropertyValue('--primary').trim();
                const colorPrimaryDark = rootStyles.getPropertyValue('--primary-dark').trim();
                const colorPrimaryLight = rootStyles.getPropertyValue('--primary-light').trim();
                const colorAccentBlue = rootStyles.getPropertyValue('--accent-blue').trim();
                const colorAccentGreen = rootStyles.getPropertyValue('--accent-green').trim();
                const colorAccentYellow = rootStyles.getPropertyValue('--accent-yellow').trim();
                const colorAccentPurple = rootStyles.getPropertyValue('--accent-purple').trim();

                // API 호출 함수들
                async function fetchAndDisplayStats() {
                    try {
                        const response = await fetch('/api/admin/dashboard/stats');
                        const result = await response.json();

                        console.log('Dashboard stats response:', result);

                        if (result.status === 1) {
                            const stats = result.data;
                            console.log('Stats data:', stats);

                            document.getElementById('total-users').textContent = (stats.totalUsers || 0).toLocaleString();
                            document.getElementById('today-signups').textContent = (stats.todaySignups || 0).toLocaleString();
                            document.getElementById('total-posts').textContent = (stats.totalPosts || 0).toLocaleString();
                            document.getElementById('pending-inquiries').textContent = (stats.pendingInquiries || 0).toLocaleString();
                        } else {
                            console.error('통계 조회 실패:', result.message);
                            // 에러 시에도 0으로 표시
                            document.getElementById('total-users').textContent = '0';
                            document.getElementById('today-signups').textContent = '0';
                            document.getElementById('total-posts').textContent = '0';
                            document.getElementById('pending-inquiries').textContent = '0';
                        }
                    } catch (error) {
                        console.error('Error loading dashboard stats:', error);
                        // 에러 시에도 0으로 표시
                        document.getElementById('total-users').textContent = '0';
                        document.getElementById('today-signups').textContent = '0';
                        document.getElementById('total-posts').textContent = '0';
                        document.getElementById('pending-inquiries').textContent = '0';
                    }
                }

                async function renderMonthlySignupsChart() {
                    try {
                        const response = await fetch('/api/admin/dashboard/monthly-signups');
                        const result = await response.json();

                        if (result.status === 1) {
                            const monthlyData = result.data;

                            // 월 이름 변환 (2025-01 -> 1월)
                            const labels = monthlyData.map(item => {
                                const month = parseInt(item.month.split('-')[1]);
                                return month + '월';
                            });
                            const data = monthlyData.map(item => item.count);

                            const ctx = document.getElementById('monthlySignupsChart');
                            if (ctx) {
                                new Chart(ctx.getContext('2d'), {
                                    type: 'line',
                                    data: {
                                        labels: labels,
                                        datasets: [{
                                            label: '가입자 수',
                                            data: data,
                                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                                            borderColor: colorAccentBlue,
                                            borderWidth: 3,
                                            fill: true,
                                            tension: 0.4,
                                            pointBackgroundColor: colorAccentBlue,
                                            pointBorderColor: '#fff',
                                            pointBorderWidth: 2,
                                            pointRadius: 5,
                                            pointHoverRadius: 7
                                        }]
                                    },
                                    options: {
                                        responsive: true,
                                        maintainAspectRatio: true,
                                        aspectRatio: 2,
                                        scales: {
                                            y: {
                                                beginAtZero: true,
                                                ticks: {
                                                    stepSize: 1
                                                }
                                            }
                                        },
                                        plugins: {
                                            legend: { display: false }
                                        }
                                    }
                                });
                            }
                        }
                    } catch (error) {
                        console.error('Error loading monthly signups:', error);
                    }
                }

                async function renderClubMembersChart() {
                    try {
                        const response = await fetch('/api/admin/dashboard/top-clubs');
                        const result = await response.json();

                        if (result.status === 1) {
                            const clubData = result.data;
                            const labels = clubData.map(item => item.clubName || '미분류');
                            const data = clubData.map(item => item.memberCount || 0);

                            const ctx = document.getElementById('clubMembersChart');
                            if (ctx) {
                                new Chart(ctx.getContext('2d'), {
                                    type: 'doughnut',
                                    data: {
                                        labels: labels,
                                        datasets: [{
                                            label: '동아리별 회원 수',
                                            data: data,
                                            backgroundColor: [
                                                colorPrimary,
                                                colorAccentGreen,
                                                colorAccentBlue,
                                                colorAccentYellow,
                                                colorAccentPurple
                                            ],
                                            borderColor: 'var(--card-bg)',
                                            borderWidth: 4,
                                            hoverOffset: 8
                                        }]
                                    },
                                    options: {
                                        responsive: true,
                                        maintainAspectRatio: true,
                                        aspectRatio: 2,
                                        plugins: {
                                            legend: {
                                                position: 'bottom',
                                                labels: {
                                                    padding: 15,
                                                    font: { size: 12 }
                                                }
                                            }
                                        }
                                    }
                                });
                            }
                        }
                    } catch (error) {
                        console.error('Error loading club members chart:', error);
                    }
                }

                // 함수 실행
                fetchAndDisplayStats();
                renderMonthlySignupsChart();
                renderClubMembersChart();
            });
        </script>
    </div>
</body>
</html>