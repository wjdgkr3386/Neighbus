<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{admin/layout :: ~{html}(pageTitle='모임 관리', activeMenu='gatherings')}">
<head>
    <title>모임 관리</title>
</head>
<body>
    <main class="main-content" th:fragment="content">
        <div class="page-header">
            <h1>모임 관리</h1>
            <p>사이트의 모든 모임을 관리합니다.</p>
        </div>

        <!-- Stats -->
        <div class="stat-cards-grid">
            <div class="stat-card">
                <div class="icon"><i class="fa-solid fa-calendar-days"></i></div>
                <div class="info"><p class="title">총 모임</p><p class="value" id="total-gatherings">0</p></div>
            </div>
            <div class="stat-card">
                <div class="icon"><i class="fa-solid fa-person-running"></i></div>
                <div class="info"><p class="title">진행 중</p><p class="value" id="active-gatherings">0</p></div>
            </div>
            <div class="stat-card">
                <div class="icon"><i class="fa-solid fa-flag-checkered"></i></div>
                <div class="info"><p class="title">종료됨</p><p class="value" id="ended-gatherings">0</p></div>
            </div>
        </div>

        <!-- Table and Filters -->
        <div class="content-panel" style="margin-top: 2rem;">
            <div class="search-controls" style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
                <input type="text" id="search-input" placeholder="모임명 또는 개설자로 검색..." style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); font-size: 1rem;">
                <select id="status-filter" style="padding: 0.75rem; border: 1px solid var(--border-color); font-size: 1rem;">
                    <option value="">전체 상태</option>
                    <option value="진행중">진행중</option>
                    <option value="마감">마감</option>
                </select>
            </div>
            <div class="table-wrapper" style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>모임명</th>
                            <th>동아리</th>
                            <th>개설자</th>
                            <th>참여인원</th>
                            <th>모임일</th>
                            <th>상태</th>
                            <th class="actions">관리</th>
                        </tr>
                    </thead>
                    <tbody id="gathering-table-body">
                        <tr th:if="${#lists.isEmpty(recruitments)}">
                            <td colspan="8" style="text-align: center; padding: 3rem; color: var(--text-secondary);">생성된 모임이 없습니다.</td>
                        </tr>
                        <tr th:each="recruitment : ${recruitments}">
                            <td th:text="${recruitment.id}">1</td>
                            <td><strong th:text="${recruitment.title}">모임명</strong></td>
                            <td th:text="${recruitment.clubName}">동아리명</td>
                            <td th:text="${recruitment.writer}">작성자</td>
                            <td>
                                <span th:text="${memberCountMap[recruitment.id]} ?: 0">0</span> /
                                <span th:text="${recruitment.maxUser}">0</span>
                            </td>
                            <td th:text="${#temporals.format(recruitment.meetingDate, 'yyyy-MM-dd HH:mm')}">2025-11-01 15:00</td>
                            <td>
                                <span th:classappend="${(memberCountMap[recruitment.id] ?: 0) >= recruitment.maxUser ? 'status-ended' : 'status-active'}"
                                      th:text="${(memberCountMap[recruitment.id] ?: 0) >= recruitment.maxUser ? '마감' : '진행중'}"
                                      class="status-badge" style="padding: 4px 10px; border-radius: 12px; font-weight: 600;"></span>
                            </td>
                            <td class="actions">
                                <button class="btn btn-secondary" th:onclick="|viewDetail(${recruitment.id})|"><i class="fa-solid fa-eye"></i></button>
                                <button class="btn btn-danger" th:onclick="|deleteGathering(${recruitment.id})|"><i class="fa-solid fa-trash"></i></button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <script th:inline="javascript">
            /*<![CDATA[*/
            const recruitments = /*[[${recruitments}]]*/ [];
            const memberCountMap = /*[[${memberCountMap}]]*/ {};
            /*]]>*/

            document.addEventListener('DOMContentLoaded', function() {
                // Add custom styles for status badges
                const style = document.createElement('style');
                style.innerHTML = `
                    .status-badge.status-active { background: var(--accent-green-light); color: var(--accent-green); }
                    .status-badge.status-ended { background: #F8E5E5; color: var(--accent-red-dark); }
                `;
                document.head.appendChild(style);
                
                updateStats();
                
                const searchInput = document.getElementById('search-input');
                if(searchInput) searchInput.addEventListener('input', applyFilters);

                const statusFilter = document.getElementById('status-filter');
                if(statusFilter) statusFilter.addEventListener('change', applyFilters);
            });

            function updateStats() {
                const total = recruitments.length;
                let active = 0;
                let ended = 0;

                recruitments.forEach(recruitment => {
                    const currentMembers = memberCountMap[recruitment.id] || 0;
                    const maxUser = recruitment.maxUser;
                    if (currentMembers >= maxUser) {
                        ended++;
                    } else {
                        active++;
                    }
                });

                document.getElementById('total-gatherings').textContent = total;
                document.getElementById('active-gatherings').textContent = active;
                document.getElementById('ended-gatherings').textContent = ended;
            }

            function viewDetail(recruitmentId) {
                window.open('/recruitment/' + recruitmentId, '_blank');
            }

            function deleteGathering(recruitmentId) {
                if (confirm('정말로 이 모임을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
                    // 실제 삭제 로직 (API 호출)
                    console.log('Deleting gathering with ID:', recruitmentId);
                    alert('모임이 삭제되었습니다. (데모)');
                    // location.reload(); // 실제 연동 시 사용
                }
            }

            function applyFilters() {
                const searchTerm = document.getElementById('search-input').value.toLowerCase();
                const statusFilter = document.getElementById('status-filter').value;
                const rows = document.querySelectorAll('#gathering-table-body tr');

                rows.forEach(row => {
                    if (!row.cells[1]) return; // 헤더 또는 빈 행 건너뛰기

                    const title = row.cells[1].textContent.toLowerCase();
                    const club = row.cells[2].textContent.toLowerCase();
                    const writer = row.cells[3].textContent.toLowerCase();
                    const statusBadge = row.cells[6].querySelector('.status-badge');
                    const statusText = statusBadge ? statusBadge.textContent.trim() : '';

                    const matchesSearch = title.includes(searchTerm) || club.includes(searchTerm) || writer.includes(searchTerm);
                    const matchesStatus = !statusFilter || statusText === statusFilter;

                    if (matchesSearch && matchesStatus) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            }
<<<<<<< HEAD
        </script>
    </main>
=======
        }

        // 검색 기능 (클라이언트 사이드)
        document.getElementById('search-input')?.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const rows = document.querySelectorAll('#gathering-table-body tr');

            rows.forEach(row => {
                const title = row.cells[1].textContent.toLowerCase();
                const writer = row.cells[3].textContent.toLowerCase();

                if (title.includes(searchTerm) || writer.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });

        // 상태 필터 기능
        document.getElementById('status-filter')?.addEventListener('change', function() {
            const filterValue = this.value;
            const rows = document.querySelectorAll('#gathering-table-body tr');

            rows.forEach(row => {
                const statusBadge = row.cells[6].querySelector('.status-badge');
                const statusText = statusBadge.textContent.trim();

                if (filterValue === '') {
                    row.style.display = '';
                } else if (filterValue === '진행중' && statusText === '진행중') {
                    row.style.display = '';
                } else if (filterValue === '종료' && statusText === '마감') {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    </script>
>>>>>>> b4a98db73a46d498a0c65cd1303a0869a17b31e7
</body>
</html>