<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{admin/layout :: layout(pageTitle='갤러리 관리', activeMenu='galleries', content=~{:: #galleries-content})}">
<body>
    <div id="galleries-content">
        <div class="page-header">
            <h1>갤러리 관리</h1>
            <p>사이트의 모든 갤러리를 관리합니다.</p>
        </div>

        <!-- Stats -->
        <div class="stat-cards-grid">
            <div class="stat-card">
                <div class="icon"><i class="fa-solid fa-image"></i></div>
                <div class="info"><p class="title">총 갤러리</p><p class="value" id="total-galleries">0</p></div>
            </div>
            <div class="stat-card">
                <div class="icon"><i class="fa-solid fa-eye"></i></div>
                <div class="info"><p class="title">총 조회수</p><p class="value" id="total-views">0</p></div>
            </div>
            <div class="stat-card">
                <div class="icon"><i class="fa-solid fa-calendar-day"></i></div>
                <div class="info"><p class="title">오늘 작성</p><p class="value" id="today-galleries">0</p></div>
            </div>
        </div>

        <!-- Table and Filters -->
        <div class="content-panel" style="margin-top: 2rem;">
            <div class="search-controls">
                <input type="text" id="search-input" placeholder="제목 또는 작성자로 검색...">
                <select id="club-filter">
                    <option value="">전체 동아리</option>
                </select>
            </div>
            <div class="table-wrapper" style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>제목</th>
                            <th>동아리</th>
                            <th>작성자</th>
                            <th>조회수</th>
                            <th>작성일</th>
                            <th class="actions">관리</th>
                        </tr>
                    </thead>
                    <tbody id="gallery-table-body">
                        <!-- JS로 채워짐 -->
                    </tbody>
                </table>
            </div>
            <nav id="pagination-nav" class="mt-4" aria-label="Page navigation"></nav>
        </div>

        <script>
            let currentPageGalleries = [];
            let currentPage = 1;
            const pageSize = 10;

            document.addEventListener('DOMContentLoaded', function() {
                loadGalleries(currentPage);
                document.getElementById('search-input').addEventListener('input', () => loadGalleries(1));
                document.getElementById('club-filter').addEventListener('change', () => loadGalleries(1));
            });

            async function loadGalleries(page) {
                try {
                    currentPage = page;
                    const keyword = document.getElementById('search-input').value;
                    const clubName = document.getElementById('club-filter').value;

                    let apiUrl = `/api/admin/galleries?page=${page}&size=${pageSize}`;
                    if (keyword) apiUrl += `&keyword=${keyword}`;
                    if (clubName) apiUrl += `&clubName=${clubName}`;

                    const response = await fetch(apiUrl);
                    const result = await response.json();

                    if (result.status === 1) {
                        const pageData = result.data;
                        currentPageGalleries = pageData.content.map(g => ({
                            id: g.galleryId,
                            title: g.title,
                            clubName: g.clubName || '미분류',
                            writerNickname: g.writerNickname || 'N/A',
                            writerUsername: g.writerUsername || 'N/A',
                            viewCount: g.viewCount || 0,
                            createdAt: g.createdAt ? new Date(g.createdAt).toISOString().slice(0, 10) : '-'
                        }));

                        updateStats(pageData);
                        renderTable();
                        renderPagination(pageData);
                        
                        if (page === 1 && !keyword && !clubName) {
                           populateClubFilter(pageData.content);
                        }
                    } else {
                        console.error('갤러리 목록 조회 실패:', result.message);
                    }
                } catch (error) {
                    console.error('Error loading galleries:', error);
                }
            }
            
            function populateClubFilter(galleries) {
                const clubFilter = document.getElementById('club-filter');
                while (clubFilter.options.length > 1) {
                    clubFilter.remove(1);
                }
                const clubs = [...new Set(galleries.map(g => g.clubName))];
                clubs.sort();
                clubs.forEach(club => {
                    if (club && club !== '미분류') {
                        const option = document.createElement('option');
                        option.value = club;
                        option.textContent = club;
                        clubFilter.appendChild(option);
                    }
                });
            }

            function updateStats(pageData) {
                document.getElementById('total-galleries').textContent = pageData.totalElements;
                document.getElementById('total-views').textContent = '?';
                document.getElementById('today-galleries').textContent = '?';
            }

            function renderTable() {
                const tableBody = document.getElementById('gallery-table-body');
                tableBody.innerHTML = '';
                if (currentPageGalleries.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 3rem;">데이터가 없습니다.</td></tr>';
                    return;
                }
                currentPageGalleries.forEach(gallery => {
                    const row = `
                        <tr>
                            <td>${gallery.id}</td>
                            <td><strong>${gallery.title}</strong></td>
                            <td>${gallery.clubName}</td>
                            <td>${gallery.writerNickname} (${gallery.writerUsername})</td>
                            <td>${gallery.viewCount}</td>
                            <td>${gallery.createdAt}</td>
                            <td class="actions">
                                <button class="btn btn-secondary btn-icon" onclick="viewGallery(${gallery.id})"><i class="fa-solid fa-eye"></i></button>
                                <button class="btn btn-danger btn-icon" onclick="deleteGallery(${gallery.id})"><i class="fa-solid fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            }

            function renderPagination(pageData) {
                const nav = document.getElementById('pagination-nav');
                nav.innerHTML = '';
                if (!pageData || pageData.totalPages <= 1) return;
                const ul = document.createElement('ul');
                ul.className = 'pagination justify-content-center';
                const prevLi = document.createElement('li');
                prevLi.className = `page-item ${pageData.number === 1 ? 'disabled' : ''}`;
                const prevA = document.createElement('a');
                prevA.className = 'page-link';
                prevA.href = '#';
                prevA.innerHTML = '<i class="fa-solid fa-chevron-left"></i>';
                prevA.onclick = (e) => { e.preventDefault(); if (pageData.number > 1) loadGalleries(pageData.number - 1); };
                prevLi.appendChild(prevA);
                ul.appendChild(prevLi);
                for (let i = 1; i <= pageData.totalPages; i++) {
                    const pageLi = document.createElement('li');
                    pageLi.className = `page-item ${i === pageData.number ? 'active' : ''}`;
                    const pageA = document.createElement('a');
                    pageA.className = 'page-link';
                    pageA.href = '#';
                    pageA.textContent = i;
                    pageA.onclick = (e) => { e.preventDefault(); if (i !== currentPage) loadGalleries(i); };
                    pageLi.appendChild(pageA);
                    ul.appendChild(pageLi);
                }
                const nextLi = document.createElement('li');
                nextLi.className = `page-item ${pageData.number === pageData.totalPages ? 'disabled' : ''}`;
                const nextA = document.createElement('a');
                nextA.className = 'page-link';
                nextA.href = '#';
                nextA.innerHTML = '<i class="fa-solid fa-chevron-right"></i>';
                nextA.onclick = (e) => { e.preventDefault(); if (pageData.number < pageData.totalPages) loadGalleries(pageData.number + 1); };
                nextLi.appendChild(nextA);
                ul.appendChild(nextLi);
                nav.appendChild(ul);
            }

            function viewGallery(galleryId) {
                window.open('/gallery/detail/' + galleryId, '_blank');
            }

            async function deleteGallery(galleryId) {
                if (!confirm('정말로 이 갤러리를 삭제하시겠습니까?')) return;
                try {
                    const csrfToken = document.querySelector('meta[name="_csrf"]').content;
                    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;
                    const headers = { 'Content-Type': 'application/json' };
                    headers[csrfHeader] = csrfToken;
                    const response = await fetch('/api/admin/galleries/delete', {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify({ id: galleryId })
                    });
                    const result = await response.json();
                    if (result.status === 1) {
                        alert('갤러리가 삭제되었습니다.');
                        loadGalleries(currentPage);
                    } else {
                        alert('삭제 실패: ' + (result.message || '알 수 없는 오류'));
                    }
                } catch (error) {
                    console.error('Error deleting gallery:', error);
                    alert('갤러리 삭제 중 오류가 발생했습니다.');
                }
            }
        </script>
    </div>
</body>
</html>
