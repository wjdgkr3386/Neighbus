<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>계정 찾기 - NEIGHBUS</title>
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-6">

                <!-- 계정 찾기 카드 -->
                <div class="card shadow-sm mb-4">
                    <div class="card-body p-4">
                        <h4 class="fw-bold mb-3">계정 찾기</h4>
                        <form id="emailFindForm">
                            <div class="mb-3">
                                <label for="emailFind" class="form-label">등록된 이메일</label>
                                <input type="email" class="form-control" id="emailFind" name="email" placeholder="이메일을 입력하세요" required>
                            </div>
                            <button type="button" class="btn btn-primary w-100" onclick="findAccount()">계정 찾기</button>
                        </form>
                    </div>
                </div>

                <!-- 비밀번호 찾기 카드 -->
                <div class="card shadow-sm">
                    <div class="card-body p-4">
                        <h4 class="fw-bold mb-3">비밀번호 찾기</h4>
                        <form class="mb-3" id="emPwFindForm">
                            <label for="pwEmail" class="form-label">이메일로 찾기</label>
                            <input type="text" class="form-control mb-3" id="username-email"  name="username" placeholder="아이디를 입력하세요" required>
                            <input type="email" class="form-control mb-3" id="emPwEmail"  name="email" placeholder="이메일을 입력하세요" required>
                            <button type="button" class="btn btn-secondary w-100" onclick="isUserByEmail()">비밀번호 찾기</button>
                            
                            <!-- 인증코드 입력창이 삽입될 영역 -->
    						<div id="verifyContainer" class="mt-3"></div>
                        </form>
                        <hr class="my-4">
                        <form id="pwPhoneForm">
                            <label for="pwPhone" class="form-label">전화번호로 찾기</label>
                            <input type="text" class="form-control mb-3" id="username-phone"  name="username" placeholder="아이디를 입력하세요" required>
                            <input type="tel" class="form-control mb-3" id="phPwPhone" name="phone" placeholder="- 없이 입력하세요" required>
                            <button type="button" class="btn btn-secondary w-100" onclick="isUserByPhone()">인증번호 받기</button>
                            <!-- 인증코드 입력창이 삽입될 영역 -->
    						<div id="verifyContainer2" class="mt-3"></div>
                        </form>
                    </div>
                </div>
                
            </div>
        </div>
    </div>
	<input type="hidden" id="code">
	<input type="hidden" id="emailHistory">
	<input type="hidden" id="phoneHistory">
	<script>
	function findAccount(){
		const email = document.getElementById('emailFind').value.trim();
		if(!email){
			alert("이메일을 입력해주세요");
			return;
		}
	    fetch('/findAccount', {
	        method: 'POST',
	        headers: {
	            "Content-Type": "application/json"
	        },
	        body: JSON.stringify({ email: email })
	    })
	    .then(res => res.json())
	    .then(data => {
	        if (data.status === 0) {
	            alert("입력하신 이메일이 가입되어있지 않습니다.");
	            return;
	        }else if (data.status === 1) {
	        	alert("아이디: "+data.username);
	        }
	    })
	    .catch(err => console.error(err));
		
	}
	function isUserByEmail() {
	    const emPwFindForm = document.getElementById('emPwFindForm');
	    const userEmail = document.getElementById('emPwEmail').value.trim();
	    const formData = new FormData(emPwFindForm);

	    if(!userEmail){
	    	alert("이메일을 입력해주세요");
	    	return;
	    }
	    
	    fetch('/findAccountByEmail', {
	        method: 'POST',
	        body: formData
	    })
	    .then(res => res.json())
	    .then(data => {
	        if (data.status === 0) {
	            alert("입력하신 이메일이 가입되어있지 않습니다.");
	            return;
	        }else if (data.status === 1) {
	        	document.getElementById('code').value=data.code;
	        	document.getElementById('emailHistory').value=userEmail;
	            showVerifyInput(1);
	        }
	    })
	    .catch(err => console.error(err));
	}
	
	function showVerifyInput(n) {
	    let container=null;
	    if(n===1){
	    	container = document.getElementById('verifyContainer');
	    }else if(n===2){
	    	container = document.getElementById('verifyContainer2');
	    }

	    container.innerHTML = `
	        <label for="verifyCode" class="form-label">인증코드 입력</label>
	        <div class="input-group mb-3">
	            <input type="text" id="verifyCode" class="form-control" placeholder="인증코드를 입력하세요">
	            <button id="verifyBtn" class="btn btn-primary" type="button">확인</button>
	        </div>
	    `;

	    // 동적으로 생성된 버튼에 이벤트 등록
	    document.getElementById('verifyBtn').addEventListener('click', function() {
	        verifyCode(n);
	    });
	}


	function verifyCode(n) {
	    const verifyCode = document.getElementById('verifyCode').value.trim();
	    const code = document.getElementById('code').value.trim();
	    if(verifyCode !== code){
	    	alert("인증번호가 틀립니다");
	    	return;
	    }else{
	    	if(n===1){
		    	const email = document.getElementById('emailHistory').value;
	
		    	fetch('/sendTempPassword', {
		    	    method: 'POST',
		    	    headers: {
		    	    	'Content-Type': 'application/json'
		    	    },
		    	    body: JSON.stringify({ email: email })
		    	})
		    	.then(response => {
		    	    alert("인증에 성공했습니다.\n임시 비밀번호를 이메일로 발송하였습니다.");
		    	    window.location.href = "/account/login";
		    	})
		    	.catch(error => console.error(error));
	    	}else if(n===2){
		    	const phone = document.getElementById('phoneHistory').value;
	
		    	fetch('/sendTempPasswordByPhoneToEmail', {
		    	    method: 'POST',
		    	    headers: {
		    	    	'Content-Type': 'application/json'
		    	    },
		    	    body: JSON.stringify({ phone: phone })
		    	})
		    	.then(response => {
		    	    alert("인증에 성공했습니다.\n임시 비밀번호를 이메일로 발송하였습니다.");
		    	    window.location.href = "/account/login";
		    	})
		    	.catch(error => console.error(error));
	    	}
	    }
	}

	function isUserByPhone(){
	    const pwPhoneForm = document.getElementById('pwPhoneForm');
	    const username = document.getElementById('username-phone').value.trim();
	    const phone = document.getElementById('phPwPhone').value.trim();
	    const formData = new FormData(pwPhoneForm);
	    
	    if(!username || !phone){
	    	alert("아이디와 전화번호를 입력해주세요");
	    	return;
	    }
	    
	    fetch('/findAccountByPhone', {
	        method: 'POST',
	        body: formData
	    })
	    .then(res => res.json())
	    .then(data => {
	        if (data.status === 0) {
	            alert("입력하신 전화번호가 가입되어있지 않습니다.");
	            return;
	        }else if (data.status === 1) {
	        	document.getElementById('code').value=data.code;
	        	document.getElementById('phoneHistory').value=phone;
	            showVerifyInput(2);
	        }
	    })
	}

	</script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
