<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="com.neighbus.freeboard.FreeboardMapper">
   
    <!-- 게시글 작성 (freeboards 테이블에 INSERT) -->
    <insert id="insertPost" parameterType="com.neighbus.freeboard.FreeboardDTO" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO freeboards (
            title,
            content,
            writer
        ) VALUES (
            #{title},
            #{content},
            #{writer}
        )
    </insert>

    <!-- 게시글 목록 조회 -->
    <select id="selectPostList" resultType="com.neighbus.freeboard.FreeboardDTO">
        SELECT
            f.id,
            f.title,
            f.content,
            f.writer,
            f.created_at AS createdAt,
            f.view_count AS viewCount,
            u.nickname AS writerNickname,
            u.username AS writerUsername
        FROM freeboards f
        JOIN users u ON f.writer = u.id
        ORDER BY f.created_at DESC
        LIMIT 100
    </select>

    <!-- 게시글 목록 조회 (페이징) -->
    <select id="selectPostListWithPaging" parameterType="com.neighbus.freeboard.FreeboardDTO" resultType="HashMap">
        SELECT
            f.id AS id,
            f.title AS title,
            f.content AS content,
            f.writer AS writer,
            f.created_at AS createdAt,
            f.view_count AS viewCount,
            u.nickname AS writerNickname,
            u.username AS writerUsername
        FROM freeboards f
        JOIN users u ON f.writer = u.id
       	WHERE
			f.club_id in (select cm.club_id from club_members cm where cm.user_id=#{userId})
            <if test="keyword != null and keyword != ''">
                and (f.title like concat('%', #{keyword}, '%')
                or u.nickname like concat('%', #{keyword}, '%'))
            </if>
             <if test="clubId gt 0">
            	and
            		f.club_id = #{clubId}
            </if>
        ORDER BY f.id DESC
        LIMIT #{rowCnt} OFFSET #{beginRowNo}
    </select>

    <!-- 게시글 전체 개수 조회 -->
    <select id="searchAllCnt" resultType="int">
        SELECT COUNT(*) FROM freeboards f
        JOIN users u ON f.writer = u.id
        <where>
            <if test="keyword != null and keyword != ''">
                and (f.title like concat('%', #{keyword}, '%')
                or u.nickname like concat('%', #{keyword}, '%'))
            </if>
        </where>
    </select>

    <!-- 게시글 상세 조회 -->
    <select id="selectPostDetail" parameterType="int" resultType="com.neighbus.freeboard.FreeboardDTO">
        SELECT 
            f.id,
            f.title,
            f.content,
            f.writer,
            f.created_at AS createdAt,
            f.view_count AS viewCount,
            u.nickname AS writerNickname,
            u.username AS writerUsername
        FROM freeboards f
        JOIN users u ON f.writer = u.id
        WHERE f.id = #{id}
    </select>
    
    <!-- 조회수 증가 -->
    <update id="incrementViewCount" parameterType="int">
        UPDATE freeboards
        SET view_count = view_count + 1
        WHERE id = #{id}
    </update>
    <!--  댓글 목록 조회 추가 (테이블: freeboard_comments) -->      
    <select id="selectCommentList" 
        resultType="com.neighbus.freeboard.CommentDTO" 
        parameterType="int">
    SELECT
        c.id,
        c.freeboard,
        c.parent,
        c.writer,
        c.content,
        c.created_at AS createdAt,
        u.username AS writerUsername  
    FROM freeboard_comments c
    JOIN users u ON c.writer = u.id
    WHERE c.freeboard = #{freeboardId} 
    ORDER BY c.parent ASC, c.created_at ASC
</select>

    <select id="selectCommentById" resultType="com.neighbus.freeboard.CommentDTO" parameterType="int">
        SELECT * FROM freeboard_comments WHERE id = #{id}
    </select>
    
    <!-- 게시글 수정 -->
    <update id="updatePost" parameterType="com.neighbus.freeboard.FreeboardDTO">
        UPDATE freeboards
        SET
            title = #{title},
            content = #{content}
        WHERE
            id = #{id}
    </update>


</mapper>