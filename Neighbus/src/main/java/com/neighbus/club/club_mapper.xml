<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.neighbus.club.ClubMapper">
   
    <insert id="insertClub" 
            parameterType="com.neighbus.club.ClubDTO" 
            useGeneratedKeys="true" 
            keyProperty="id">

		INSERT INTO clubs (
		    club_name,
		    club_info,
		    city,
		    province_id,
		    created_at
		) VALUES (
		    #{clubName}, #{clubInfo}, #{city}, #{provinceId}, NOW()
		)
    </insert>

    <insert id="insertClubMember"
        parameterType="com.neighbus.club.ClubMemberDTO">

		INSERT INTO club_members (
		    club_id,
		    user_id,
		    created_at
		) VALUES (
		    #{clubId}, #{userId}, NOW()
		)
    </insert>

	<select id="findAllClubs" resultType="com.neighbus.club.ClubDTO">
    SELECT
        c.id,
        c.club_name AS clubName,
        c.city,
        c.club_img AS clubImg,
        c.club_info AS clubInfo,
        ci.city AS cityName,
        c.created_at AS createdAt,
        p.province AS provinceName
    FROM clubs c
    LEFT JOIN provinces p
        ON c.province_id = p.id LEFT JOIN cities ci
        ON c.city = ci.id
</select>

    <select id="isMember" parameterType="com.neighbus.club.ClubMemberDTO" resultType="int">
        SELECT COUNT(*)
        FROM club_members
        WHERE club_id = #{clubId} AND user_id = #{userId}
    </select>
    
     <select id="getClubById" parameterType="int" resultType="com.neighbus.club.ClubDTO">
    SELECT
        c.id,
        c.club_name AS clubName,
        c.club_info AS clubInfo,
        ci.city AS cityName,
        c.created_at AS createdAt,
        p.province AS provinceName
    FROM clubs c
    LEFT JOIN cities ci
        ON c.city = ci.id
    LEFT JOIN provinces p
        ON c.province_id = p.id WHERE c.id = #{id}
</select>

<select id="getNewClub" resultType="HashMap">
	select
	    c.id as id,
	    c.club_name as clubName,
	    c.club_info as clubInfo,
	    c.province_id as provinceId,
	    c.city as cityId,
	    c.club_img as clubImg,
	    c.created_at as created,
	    count(m.user_id) as memberCount
	from
	    clubs c
	left join
	    club_members m
	        on c.id = m.club_id
	group by
	    c.id, c.club_name, c.club_info, c.province_id, c.city, c.club_img, c.created_at
	order by
	    c.id desc
	limit 4;
</select>

<select id="getPopularClub" resultType="HashMap">
select
    c.id as id,
    c.club_name as clubName,
    c.club_info as clubInfo,
    c.province_id as provinceId,
    c.city as cityId,
    c.club_img as clubImg,
    c.created_at as created,
    count(m.user_id) as memberCount
from
    clubs c
left join
    club_members m
        on c.id = m.club_id
group by
    c.id, c.club_name, c.club_info, c.province_id, c.city, c.club_img, c.created_at
order by
    memberCount desc
limit 4;

</select>
    
</mapper>