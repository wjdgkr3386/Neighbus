<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.neighbus.gallery.GalleryMapper">

	<resultMap id="galleryMap" type="map">
	    <id property="ID" column="ID"/>
	    <result property="TITLE" column="TITLE"/>
	    <result property="CONTENT" column="CONTENT"/>
	    <result property="WRITER" column="WRITER"/>
	    <result property="CREATED_AT" column="CREATED_AT"/>
	    <result property="VIEW_COUNT" column="VIEW_COUNT"/>
	
	    <collection property="IMAGES" ofType="map" select="getGalleryImage" column="ID"/>
	    <collection property="COMMENTS" ofType="map" select="getCommentsByGalleryId" column="ID"/>
	</resultMap>
	
	<!-- 대댓글용 resultMap -->
	<resultMap id="replyMap" type="map">
	    <id property="ID" column="ID"/>
	    <result property="WRITER" column="WRITER"/>
	    <result property="CONTENT" column="CONTENT"/>
	    <result property="CREATED_AT" column="CREATED_AT"/>
	    <result property="PARENT" column="PARENT"/>
	</resultMap>
	
	<!-- 댓글용 resultMap -->
	<resultMap id="commentMap" type="map">
	    <id property="ID" column="ID"/>
	    <result property="WRITER" column="WRITER"/>
	    <result property="CONTENT" column="CONTENT"/>
	    <result property="CREATED_AT" column="CREATED_AT"/>
	    <result property="PARENT" column="PARENT"/>
	    
	    <!-- 대댓글 컬렉션 -->
	    <collection property="REPLIES" ofType="map" select="getRepliesByCommentId" column="ID"/>
	</resultMap>

	<insert id="insertGallery" parameterType="com.neighbus.gallery.GalleryDTO">
		insert into galleries (
			title,
			content,
			writer
		) values (
			#{title},
			#{content},
			#{writer}
		)
	</insert>
	
	<insert id="insertGalleryImage" parameterType="com.neighbus.gallery.GalleryDTO">
		insert into gallery_images (
			gallery,
			img
		) values 
		    <foreach collection="fileNameList" item="i" separator=",">
		        (#{galleryId}, #{i})
		    </foreach>
	</insert>
	
	<insert id="insertComment" parameterType="HashMap">
		insert into gallery_comments(
			gallery,
			parent,
			writer,
			content
		) values (
			#{gallery_id},
			#{parent},
			#{user_id},
			#{comment}
		)
	</insert>
	
	<select id="getGalleryMaxId" parameterType="com.neighbus.gallery.GalleryDTO" resultType="int">
		select max(id) from galleries where writer=#{writer}
	</select>
	
	<select id="searchAllCnt" resultType="int">
		select count(*) from galleries
	</select>

	<select id="getGalleryList" parameterType="com.neighbus.gallery.GalleryDTO" resultMap="galleryMap">
	    select
	        id as ID,
	        title as TITLE,
	        content as CONTENT,
	        writer as WRITER,
	        created_at as CREATED_AT,
	        view_count as VIEW_COUNT
	    from galleries
	    order by id asc
	    limit #{rowCnt} offset #{beginRowNo}
	</select>
	
	<select id="getGalleryImage" resultType="map">
	    select
	        gallery as GALLERY,
	        id as ID,
	        img as IMG
	    from gallery_images
	    where gallery = #{ID}
	    order by id asc
	</select>
	
	<select id="getGalleryById" parameterType="int" resultMap="galleryMap">
		select
	        g.id as ID,
	        g.title as TITLE,
	        g.content as CONTENT,
	        (select name from users u where u.id=g.writer) as WRITER,
	        DATE_FORMAT(g.created_at, '%Y-%m-%d %H:%i') as CREATED_AT,
	        g.view_count as VIEW_COUNT
		from
			galleries g
		where
			id=#{id}
	</select>
	
	<select id="getCommentsByGalleryId" parameterType="int" resultMap="commentMap">
	    select
	        c.id as ID,
	        (select name from users u where u.id = c.writer) as WRITER,
	        c.content as CONTENT,
	        c.created_at as CREATED_AT,
	        c.parent as PARENT
	    from gallery_comments c
	    where c.gallery = #{ID} and c.parent is null
	    order by c.id asc
	</select>

	<select id="getRepliesByCommentId" parameterType="int" resultMap="replyMap">
	    select
	        c.id as ID,
	        (select name from users u where u.id = c.writer) as WRITER,
	        c.content as CONTENT,
	        c.created_at as CREATED_AT,
	        c.parent as PARENT
	    from gallery_comments c
	    where c.parent = #{ID}
	    order by c.id asc
	</select>
	
	<update id="updateViewCount" parameterType="int">
		update galleries set view_count=view_count+1 where id=#{id}
	</update>
</mapper>