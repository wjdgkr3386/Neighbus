<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.neighbus.gallery.GalleryMapper">

	<insert id="insertGallery" parameterType="com.neighbus.gallery.GalleryDTO">
		insert into galleries (
			title,
			content,
			writer
		) values (
			#{title},
			#{content},
			#{writer}
		)
	</insert>
	
	<insert id="insertGalleryImage" parameterType="com.neighbus.gallery.GalleryDTO">
		insert into gallery_images (
			gallery,
			img
		) values 
		    <foreach collection="fileNameList" item="i" separator=",">
		        (#{galleryId}, #{i})
		    </foreach>
	</insert>
	
	<select id="getGalleryMaxId" parameterType="com.neighbus.gallery.GalleryDTO" resultType="int">
		select max(id) from galleries where writer=#{writer}
	</select>
	
	<select id="searchAllCnt" resultType="int">
		select count(*) from galleries
	</select>
	
	<resultMap id="galleryMap" type="map">
	    <id property="ID" column="ID"/>
	    <result property="TITLE" column="TITLE"/>
	    <result property="CONTENT" column="CONTENT"/>
	    <result property="WRITER" column="WRITER"/>
	    <result property="CREATED_AT" column="CREATED_AT"/>
	    <result property="VIEW_COUNT" column="VIEW_COUNT"/>
	
	    <collection property="IMAGES" ofType="map" select="getGalleryImage" column="ID"/>
	</resultMap>

	<select id="getGalleryList" parameterType="com.neighbus.gallery.GalleryDTO" resultMap="galleryMap">
	    select
	        id as ID,
	        title as TITLE,
	        content as CONTENT,
	        writer as WRITER,
	        created_at as CREATED_AT,
	        view_count as VIEW_COUNT
	    from galleries
	    order by id asc
	    limit #{rowCnt} offset #{beginRowNo}
	</select>
	
	<select id="getGalleryImage" resultType="map">
	    select
	        gallery as GALLERY,
	        id as ID,
	        img as IMG
	    from gallery_images
	    where gallery = #{ID}
	    order by id asc
	</select>
	
	<select id="getGalleryById" parameterType="int" resultMap="galleryMap">
		select
	        id as ID,
	        title as TITLE,
	        content as CONTENT,
	        writer as WRITER,
	        created_at as CREATED_AT,
	        view_count as VIEW_COUNT
		from
			galleries
		where
			id=#{id}
	    order by id asc
	</select>
</mapper>